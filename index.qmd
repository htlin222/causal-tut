# å¼•è¨€ {data-stack-name="å¼•è¨€"}

## æ¼”è¬›ä¸»é¡Œ

**è§€å¯Ÿæ€§ç ”ç©¶çš„å› æœæ¨è«–ï¼šçµ¦è‡¨åºŠé†«å¸«çš„å¯¦æˆ°æŒ‡å—**

*Causal Inference from Observational Studies: A Practical Guide for Clinicians*

## ä»Šå¤©ä½ æœƒå­¸åˆ°ä»€éº¼ï¼Ÿ

::: {.incremental}
1. **ç‚ºä»€éº¼**ï¼šè§€å¯Ÿæ€§ç ”ç©¶ç‚ºä½•ä¸èƒ½ç›´æ¥ä¸‹å› æœçµè«–ï¼Ÿ
2. **æ€éº¼æƒ³**ï¼šå¦‚ä½•è¨­è¨ˆç ”ç©¶å•é¡Œï¼Ÿï¼ˆTarget Trialï¼‰
3. **æ€éº¼åš**ï¼šç”¨ä»€éº¼æ–¹æ³•åˆ†æï¼Ÿï¼ˆTMLE + Super Learnerï¼‰
4. **æ€éº¼é©—è­‰**ï¼šå¦‚ä½•ç¢ºèªçµæœå¯ä¿¡ï¼Ÿï¼ˆæ•æ„Ÿåº¦åˆ†æï¼‰
:::

## èª²ç¨‹åœ°åœ–

```{mermaid}
%%| fig-width: 10
flowchart LR
    A[å•é¡Œï¼šç‚ºä»€éº¼éœ€è¦ï¼Ÿ] --> B[è¨­è¨ˆï¼šTarget Trial]
    B --> C[æ–¹æ³•ï¼šPS + TMLE]
    C --> D[å¯¦ä½œï¼šR code]
    D --> E[é©—è­‰ï¼šE-value]
```

::: {.fragment}
æ¯å€‹éšæ®µéƒ½æœƒæœ‰**å¯¦ä¾‹**å’Œ**ç¨‹å¼ç¢¼**
:::

```{r}
#| label: setup-theme
#| include: false

# çµ±ä¸€çš„ R è¨­å®š
library(ggplot2)
library(showtext)

# è¼‰å…¥ä¸­æ–‡å­—é«”
font_add("openhuninn", "jf-openhuninn-2.1.ttf")
showtext_auto()

# ä¸€è‡´çš„è‰²ç›¤
colors <- list(
  treatment = "#E69F00",
  control = "#56B4E9",
  robust = "#2E86AB",
  fragile = "#E94F37",
  accent = "#3d6869"
)

# çµ±ä¸€ä¸»é¡Œ
theme_causal <- function(base_size = 16) {
  theme_minimal(base_size = base_size, base_family = "openhuninn") +
    theme(
      legend.position = "top",
      plot.title = element_text(face = "bold"),
      panel.grid.minor = element_blank()
    )
}
```

# ç¬¬ä¸€éƒ¨åˆ†ï¼šç‚ºä»€éº¼éœ€è¦å› æœæ¨è«–ï¼Ÿ {data-stack-name="ç‚ºä»€éº¼"}

## é–‹å ´æƒ…å¢ƒï¼šä¸€å€‹ã€ŒæˆåŠŸã€çš„ç ”ç©¶

::: {.callout-note appearance="minimal"}
## æŸé†«å­¸ä¸­å¿ƒå›é¡§æ€§ç ”ç©¶å ±å‘Š
ã€Œæ–°è—¥ DrugX é¡¯è‘—æå‡æ™šæœŸç™Œç—‡ç—…äººå­˜æ´»ç‡ã€
:::

## ç ”ç©¶çµæœçœ‹èµ·ä¾†å¾ˆæ£’ï¼

| çµ„åˆ¥ | äººæ•¸ | ä¸€å¹´å­˜æ´»ç‡ | p-value |
|:----:|:----:|:----------:|:-------:|
| æ–°è—¥çµ„ | 500 | **70%** | |
| å‚³çµ±æ²»ç™‚ | 500 | 50% | **< 0.001** |

::: {.fragment}
çµ±è¨ˆé¡¯è‘—ã€æ•ˆæœé‡å¤§ã€æ¨£æœ¬æ•¸å¤ ...

**å¯ä»¥ç™¼ paper äº†å—ï¼Ÿ**
:::

## ç­‰ç­‰ï¼Œè®“æˆ‘å€‘çœ‹çœ‹ç—…äººç‰¹å¾µ...

::: {.columns}
::: {.column width="50%"}
**æ–°è—¥çµ„**

- å¹³å‡å¹´é½¡ï¼š55 æ­²
- ECOG 0-1ï¼š85%
- å…±ç—…æŒ‡æ•¸ï¼š1.2
:::
::: {.column width="50%"}
**å‚³çµ±æ²»ç™‚çµ„**

- å¹³å‡å¹´é½¡ï¼š68 æ­²
- ECOG 0-1ï¼š45%
- å…±ç—…æŒ‡æ•¸ï¼š3.8
:::
:::

::: {.fragment .fade-up}
ğŸ˜± **å…©çµ„æ ¹æœ¬ä¸ä¸€æ¨£ï¼**
:::

## æ··æ·†æ•ˆæ‡‰è¦–è¦ºåŒ–ï¼šSimpson's Paradox

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 5

# Simpson's Paradox é¢¨æ ¼çš„æ··æ·†æ•ˆæ‡‰å±•ç¤º
set.seed(2024)

# æ¨¡æ“¬è³‡æ–™ï¼šè¼•ç—‡å’Œé‡ç—‡ç—…äººçš„æ²»ç™‚æ•ˆæœ
n_per_group <- 100

# è¼•ç—‡ç—…äºº
light_treated <- data.frame(
  severity = "è¼•ç—‡",
  treatment = "æ–°è—¥",
  survival = rbinom(n_per_group, 1, 0.85)
)
light_control <- data.frame(
  severity = "è¼•ç—‡",
  treatment = "å‚³çµ±æ²»ç™‚",
  survival = rbinom(n_per_group * 0.3, 1, 0.80)
)

# é‡ç—‡ç—…äºº
severe_treated <- data.frame(
  severity = "é‡ç—‡",
  treatment = "æ–°è—¥",
  survival = rbinom(n_per_group * 0.3, 1, 0.45)
)
severe_control <- data.frame(
  severity = "é‡ç—‡",
  treatment = "å‚³çµ±æ²»ç™‚",
  survival = rbinom(n_per_group, 1, 0.40)
)

df_simpson <- rbind(
  light_treated,
  light_control,
  severe_treated,
  severe_control
)

# è¨ˆç®—åˆ†å±¤å­˜æ´»ç‡
summary_by_severity <- aggregate(
  survival ~ severity + treatment,
  df_simpson,
  mean
)
summary_overall <- aggregate(survival ~ treatment, df_simpson, mean)
summary_overall$severity <- "æ•´é«”ï¼ˆæœªåˆ†å±¤ï¼‰"

combined <- rbind(summary_by_severity, summary_overall)
combined$severity <- factor(
  combined$severity,
  levels = c("æ•´é«”ï¼ˆæœªåˆ†å±¤ï¼‰", "è¼•ç—‡", "é‡ç—‡")
)

ggplot(combined, aes(x = treatment, y = survival * 100, fill = treatment)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(
    aes(label = sprintf("%.0f%%", survival * 100)),
    vjust = -0.5,
    size = 5,
    family = "openhuninn"
  ) +
  facet_wrap(~severity, ncol = 3) +
  scale_fill_manual(
    values = c("æ–°è—¥" = colors$treatment, "å‚³çµ±æ²»ç™‚" = colors$control)
  ) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 25)) +
  labs(
    x = "",
    y = "å­˜æ´»ç‡ (%)",
    fill = ""
  ) +
  theme_causal() +
  theme(
    strip.text = element_text(size = 14, face = "bold"),
    legend.position = "none"
  )
```

::: {.fragment}
**è§€å¯Ÿ**ï¼šæ•´é«”çœ‹èµ·ä¾†æ–°è—¥å¥½å¾ˆå¤šï¼Œä½†åˆ†å±¤å¾Œå·®ç•°è®Šå°ï¼
:::

::: {.notes}
é€™å°±æ˜¯ Simpson's Paradox - æ•´é«”çš„é—œè¯æ–¹å‘å¯èƒ½è·Ÿåˆ†å±¤å¾Œä¸åŒã€‚é†«å¸«å‚¾å‘é–‹æ–°è—¥çµ¦è¼•ç—‡ç—…äººï¼Œæ‰€ä»¥æ–°è—¥çµ„æœ‰æ›´å¤šè¼•ç—‡ã€å­˜æ´»ç‡æœ¬ä¾†å°±é«˜ã€‚
:::

## çœŸç›¸å¤§ç™½

::: {.incremental}
- é†«å¸«å‚¾å‘é–‹æ–°è—¥çµ¦ã€Œç‹€æ³è¼ƒå¥½ã€çš„ç—…äºº
- æ–°è—¥çµ„æœ¬ä¾†å°±æœƒæ´»æ¯”è¼ƒä¹…
- 70% vs 50% çš„å·®ç•°ï¼Œæœ‰å¤šå°‘æ˜¯è—¥æ•ˆï¼Ÿæœ‰å¤šå°‘æ˜¯é¸æ“‡åèª¤ï¼Ÿ
:::

::: {.fragment}
### æ ¸å¿ƒå•é¡Œ

> **è§€å¯Ÿåˆ°çš„å·®ç•° â‰  å› æœæ•ˆæ‡‰**
:::

## é—œè¯ vs å› æœ

::: {.incremental}
- **æè¿°æ€§å•é¡Œ**ï¼šã€Œç”¨æ–°è—¥çš„äººå’Œæ²’ç”¨çš„äººï¼Œçµæœæœ‰æ²’æœ‰ä¸åŒï¼Ÿã€
- **å› æœæ€§å•é¡Œ**ï¼šã€Œå¦‚æœè®“åŒä¸€ç¾¤äººç”¨æ–°è—¥ vs ä¸ç”¨ï¼Œçµæœæœƒä¸æœƒä¸åŒï¼Ÿã€
- **æ ¸å¿ƒå›°é›£**ï¼šåäº‹å¯¦ (counterfactual) æ°¸é è§€å¯Ÿä¸åˆ°
:::

## åäº‹å¯¦ï¼šæˆ‘å€‘æ°¸é åªçœ‹åˆ°ä¸€åŠ

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 5

library(ggplot2)

# å»ºç«‹åäº‹å¯¦æ¦‚å¿µçš„è³‡æ–™
patient_data <- data.frame(
  patient = rep(c("ç—…äºº A", "ç—…äºº B", "ç—…äºº C"), each = 2),
  scenario = rep(c("å¯¦éš›è§€å¯Ÿ", "åäº‹å¯¦"), 3),
  treatment = c(
    "ç”¨æ–°è—¥",
    "ä¸ç”¨æ–°è—¥", # A
    "ä¸ç”¨æ–°è—¥",
    "ç”¨æ–°è—¥", # B
    "ç”¨æ–°è—¥",
    "ä¸ç”¨æ–°è—¥"
  ), # C
  outcome = c(
    1,
    NA, # A: ç”¨æ–°è—¥ï¼Œå­˜æ´»ï¼›å¦‚æœä¸ç”¨å‘¢ï¼ŸæœªçŸ¥
    0,
    NA, # B: ä¸ç”¨æ–°è—¥ï¼Œæ­»äº¡ï¼›å¦‚æœç”¨å‘¢ï¼ŸæœªçŸ¥
    1,
    NA
  ), # C: ç”¨æ–°è—¥ï¼Œå­˜æ´»ï¼›å¦‚æœä¸ç”¨å‘¢ï¼ŸæœªçŸ¥
  observed = c(TRUE, FALSE, TRUE, FALSE, TRUE, FALSE)
)

patient_data$outcome_label <- ifelse(
  is.na(patient_data$outcome),
  "?",
  ifelse(patient_data$outcome == 1, "å­˜æ´»", "æ­»äº¡")
)
patient_data$treatment <- factor(
  patient_data$treatment,
  levels = c("ç”¨æ–°è—¥", "ä¸ç”¨æ–°è—¥")
)
patient_data$scenario <- factor(
  patient_data$scenario,
  levels = c("å¯¦éš›è§€å¯Ÿ", "åäº‹å¯¦")
)

ggplot(patient_data, aes(x = scenario, y = patient)) +
  geom_tile(
    aes(fill = observed),
    color = "white",
    linewidth = 2,
    width = 0.9,
    height = 0.8
  ) +
  geom_text(
    aes(label = paste0(treatment, "\n", outcome_label)),
    size = 5,
    family = "openhuninn",
    color = ifelse(patient_data$observed, "white", "gray40")
  ) +
  scale_fill_manual(
    values = c("TRUE" = colors$accent, "FALSE" = "gray90"),
    guide = "none"
  ) +
  labs(x = "", y = "") +
  theme_causal() +
  theme(
    axis.text = element_text(size = 14),
    panel.grid = element_blank()
  )
```

::: {.fragment}
**å› æœæ¨è«–çš„æ ¸å¿ƒå•é¡Œ**ï¼šæˆ‘å€‘æƒ³çŸ¥é“ã€Œ?ã€æ˜¯ä»€éº¼ï¼Œä½†æ°¸é ç„¡æ³•ç›´æ¥è§€å¯Ÿ
:::

## ç¶“å…¸è¬¬èª¤æ¡ˆä¾‹

| è§€å¯Ÿåˆ°çš„é—œè¯ | çœŸæ­£çš„åŸå›  |
|:------------|:----------|
| ğŸ¦ å†°æ·‡æ·‹éŠ·é‡ â†‘ â†’ æººæ°´æ­»äº¡ â†‘ | å¤å¤©ï¼ˆå¤©æ°£ç†±ï¼‰|
| ğŸ¥ ä½é™¢ç—…äººæ­»äº¡ç‡ > åœ¨å®¶ | ç—…é‡æ‰ä½é™¢ |
| ğŸ‘Ÿ é‹å­å°ºå¯¸å¤§ â†’ é–±è®€èƒ½åŠ›å¼· | å¹´é½¡ï¼ˆå°å­©é•·å¤§ï¼‰|
| ğŸŒ¡ï¸ é»ƒè‰²æ‰‹æŒ‡ â†’ è‚ºç™Œé¢¨éšª â†‘ | æŠ½è¸ |

::: {.fragment}
**é€™äº›éƒ½æ˜¯ã€Œæ··æ·†ã€é€ æˆçš„å‡è±¡ï¼**
:::

## è‡¨åºŠå¸¸è¦‹é™·é˜±

::: {.incremental}
- **ç”¨ statin çš„äººå¿ƒè¡€ç®¡äº‹ä»¶å°‘** â†’ ä½†ä»–å€‘æœ¬ä¾†å°±æ¯”è¼ƒæ³¨é‡å¥åº·
- **åšç¯©æª¢çš„äººå­˜æ´»è¼ƒä¹…** â†’ Lead-time bias + å¥åº·è€…åèª¤
- **ICU ç”¨æŸè—¥çš„ç—…äººæ­»äº¡ç‡é«˜** â†’ å› ç‚ºç—…æƒ…åš´é‡æ‰ç”¨
- **è¡“å¾Œæ—©æœŸä¸‹åºŠçš„ç—…äººæ¢å¾©å¿«** â†’ æ¢å¾©å¥½çš„æ‰èƒ½ä¸‹åºŠ
:::

::: {.fragment}
### é—œéµæ€è€ƒ

> æ˜¯ã€Œæ²»ç™‚ â†’ çµæœã€ï¼Œé‚„æ˜¯ã€ŒæŸå› ç´  â†’ æ²»ç™‚ & çµæœã€ï¼Ÿ
:::

## æ··æ·†çš„å•é¡Œ

::: {.columns}
::: {.column width="50%"}
**ç‚ºä»€éº¼ç›´æ¥æ¯”è¼ƒæœƒæœ‰åèª¤ï¼Ÿ**

é†«å¸«å‚¾å‘é–‹æ–°è—¥çµ¦è¼ƒè¼•ç—‡çš„ç—…äºº

â†’ æ–°è—¥çµ„æœ¬ä¾†å°±æœƒæ¯”è¼ƒå¥½
:::
::: {.column width="50%"}
```{mermaid}
%%| fig-width: 4
flowchart TD
    C[ç—…äººåš´é‡åº¦] --> A[æ²»ç™‚é¸æ“‡]
    C --> Y[çµæœ]
    A -.->|?| Y
```
:::
:::

## å°çµï¼šç‚ºä»€éº¼éœ€è¦å› æœæ¨è«–ï¼Ÿ

::: {.incremental}
1. è§€å¯Ÿæ€§è³‡æ–™ä¸­ï¼Œ**é—œè¯ â‰  å› æœ**
2. æ··æ·†å› å­æœƒè®“æˆ‘å€‘å¾—åˆ°éŒ¯èª¤çš„çµè«–
3. æˆ‘å€‘éœ€è¦ç‰¹æ®Šæ–¹æ³•ä¾†ã€Œæ¨¡æ“¬ã€éš¨æ©Ÿåˆ†é…çš„æ•ˆæœ
:::

::: {.fragment}
> **ä¸‹ä¸€æ­¥**ï¼šé‚£è¦æ€éº¼è¨­è¨ˆç ”ç©¶ï¼Œæ‰èƒ½å›ç­”å› æœå•é¡Œå‘¢ï¼Ÿ
:::

# ç¬¬äºŒéƒ¨åˆ†ï¼šç ”ç©¶è¨­è¨ˆæ€ç¶­ {data-stack-name="è¨­è¨ˆæ€ç¶­"}

## æœ¬ç¯€é‡é»

åœ¨é–‹å§‹åˆ†æä¹‹å‰ï¼Œä½ éœ€è¦å…ˆæƒ³æ¸…æ¥šï¼š

::: {.incremental}
- ä½ åˆ°åº•æƒ³å›ç­”ä»€éº¼å•é¡Œï¼Ÿ
- å¦‚æœå¯ä»¥åš RCTï¼Œä½ æœƒæ€éº¼è¨­è¨ˆï¼Ÿ
- å“ªäº›è®Šæ•¸è©²èª¿æ•´ï¼Œå“ªäº›ä¸è©²èª¿æ•´ï¼Ÿ
:::

## Target Trial Emulation

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šã€Œå¦‚æœèƒ½åš RCTï¼Œä½ æœƒæ€éº¼è¨­è¨ˆï¼Ÿã€

::: {.fragment}
ç”¨è§€å¯Ÿæ€§è³‡æ–™æ¨¡æ“¬é‚£å€‹ç†æƒ³è©¦é©—
:::

## ç‚ºä»€éº¼éœ€è¦ Target Trialï¼Ÿ

::: {.incremental}
- å¾ˆå¤šé‡è¦å•é¡Œ **ç„¡æ³•** åš RCTï¼ˆå€«ç†ã€æˆæœ¬ã€æ™‚é–“ï¼‰
- è§€å¯Ÿæ€§ç ”ç©¶å¸¸çŠ¯çš„éŒ¯ï¼šæ²’æœ‰æ˜ç¢ºçš„ç ”ç©¶è¨­è¨ˆ
- Target Trial å¼·è¿«ä½ æ€è€ƒï¼šã€Œæˆ‘åˆ°åº•åœ¨å•ä»€éº¼å•é¡Œï¼Ÿã€
:::

::: {.fragment}
> "If you can't describe the trial you're trying to emulate, you probably shouldn't be doing the analysis."
> â€” Miguel HernÃ¡n
:::

## RCT vs è§€å¯Ÿæ€§ç ”ç©¶

| æ­¥é©Ÿ | RCT | Target Trial Emulation |
|:-----|:----|:-----------------------|
| å®šç¾©è³‡æ ¼æ¢ä»¶ | Protocol å¯«å¥½ | ä½ è¦è‡ªå·±å®šç¾© |
| æ²»ç™‚åˆ†é… | **éš¨æ©Ÿ** | è§€å¯Ÿï¼ˆéœ€èª¿æ•´æ··æ·†ï¼‰|
| Time zero | éš¨æ©Ÿåˆ†é…æ™‚ | **ä½ è¦æ˜ç¢ºå®šç¾©** |
| è¿½è¹¤ | Protocol è¦å®š | è³‡æ–™åº«é™åˆ¶ |
| åˆ†æ | ITT / Per-protocol | æ¨¡æ“¬ ITT / Per-protocol |

::: {.fragment}
**é—œéµå·®ç•°**ï¼šRCT çš„éš¨æ©ŸåŒ–å¹«ä½ è™•ç†æ··æ·†ï¼Œè§€å¯Ÿæ€§ç ”ç©¶è¦è‡ªå·±è™•ç†
:::

## Target Trial å¯¦ä¾‹

::: {.callout-tip appearance="minimal"}
## ç ”ç©¶å•é¡Œï¼šStatin æ˜¯å¦é™ä½å¿ƒè¡€ç®¡æ­»äº¡ï¼Ÿ
:::

::: {.columns}
::: {.column width="50%"}
**ç†æƒ³çš„ RCT**

- ç´å…¥ï¼š40-75æ­²ã€é«˜è¡€è„‚
- éš¨æ©Ÿåˆ†é… statin vs placebo
- è¿½è¹¤ 5 å¹´
- ä¸»è¦çµå±€ï¼šCV æ­»äº¡
:::
::: {.column width="50%"}
**ç”¨å¥ä¿è³‡æ–™æ¨¡æ“¬**

- ç´å…¥ï¼šåŒæ¢ä»¶ã€é¦–æ¬¡è¨ºæ–·é«˜è¡€è„‚
- æ¯”è¼ƒï¼šé–‹å§‹ç”¨ statin vs æœªä½¿ç”¨
- Time zeroï¼šè¨ºæ–·æ—¥
- è¿½è¹¤è‡³ CV æ­»äº¡æˆ– 5 å¹´
:::
:::

## Target Trial ä¸ƒè¦ç´ 

| è¦ç´  | ä½ è¦å®šç¾©çš„ |
|------|-----------|
| è³‡æ ¼æ¢ä»¶ | èª°å¯ä»¥ç´å…¥ï¼Ÿ |
| æ²»ç™‚ç­–ç•¥ | æ–°è—¥ vs ä»€éº¼ï¼Ÿ |
| æ²»ç™‚åˆ†é… | ç—…äººå¦‚ä½•è¢«åˆ†çµ„ï¼ˆè§€å¯Ÿæ€§ï¼‰|
| è¿½è¹¤èµ·é» | Time zero æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ |
| çµæœ | ä¸»è¦ outcome |
| è¿½è¹¤æœŸé–“ | è¿½å¤šä¹…ï¼Ÿ |
| å› æœå°æ¯” | è¦ä¼°è¨ˆä»€éº¼ï¼ŸATE? |

## âš ï¸ å¸¸è¦‹é™·é˜±ï¼šImmortal Time Bias

::: {.callout-warning appearance="minimal"}
## ä¸æ­»æ™‚é–“åå·®
ç—…äººå¿…é ˆã€Œæ´»åˆ°æŸæ™‚é–“é»ã€æ‰è¢«æ­¸é¡ç‚ºæ²»ç™‚çµ„ï¼Œå°è‡´æ²»ç™‚çµ„çœ‹èµ·ä¾†æ¯”è¼ƒå¥½
:::

::: {.columns}
::: {.column width="50%"}
**éŒ¯èª¤è¨­è¨ˆ**

- ä½é™¢ç¬¬ 3 å¤©é–‹å§‹ç”¨è—¥ â†’ æ­¸ç‚ºæ²»ç™‚çµ„
- ä½†å‰ 3 å¤©æ˜¯ã€Œä¸æ­»æ™‚é–“ã€
- æ²»ç™‚çµ„å…ˆå¤©å­˜æ´»å„ªå‹¢ï¼
:::
::: {.column width="50%"}
**æ­£ç¢ºåšæ³•**

- Time zero = ç¬¦åˆæ¢ä»¶çš„æ™‚é–“é»
- æ‰€æœ‰äººå¾åŒä¸€èµ·é»é–‹å§‹è¿½è¹¤
- æˆ–ç”¨æ™‚é–“è®Šå‹•æ¨¡å‹è™•ç†
:::
:::

## DAG å› æœåœ–ï¼ˆç°¡åŒ–ç‰ˆï¼‰

**ä¸‰ç¨®è®Šæ•¸**ï¼š

::: {.incremental}
- **æ··æ·†å› å­** (Confounder)ï¼šè©²èª¿æ•´
  - å¹´é½¡ï¼šå½±éŸ¿ç”¨è—¥é¸æ“‡ï¼Œä¹Ÿå½±éŸ¿é å¾Œ
  - å…±ç—…ï¼šé†«å¸«è€ƒé‡å…±ç—…æ±ºå®šæ²»ç™‚ï¼Œå…±ç—…ä¹Ÿå½±éŸ¿çµæœ
- **ä¸­ä»‹è®Šæ•¸** (Mediator)ï¼šä¸è©²èª¿æ•´
  - è¡€å£“ä¸‹é™ï¼šé™å£“è—¥ â†’ è¡€å£“â†“ â†’ å¿ƒè¡€ç®¡äº‹ä»¶â†“
  - è¡€ç³–æ§åˆ¶ï¼šç³–å°¿ç—…è—¥ â†’ HbA1câ†“ â†’ ä½µç™¼ç—‡â†“
- **ç¢°æ’è®Šæ•¸** (Collider)ï¼šä¸è©²èª¿æ•´
  - ä½é™¢ï¼šç–¾ç—…åš´é‡ â†’ ä½é™¢ â† æ²»ç™‚å‰¯ä½œç”¨
  - å­˜æ´»åˆ°æŸæ™‚é»ï¼šå¥½é«”è³ª â†’ å­˜æ´» â† æœ‰æ•ˆæ²»ç™‚
:::

## DAG è¦–è¦ºåŒ–ï¼šä¸‰ç¨®çµæ§‹

```{r}
#| echo: false
#| fig-width: 12
#| fig-height: 4
#| message: false

library(ggdag)
library(dagitty)
library(patchwork)

# å®šç¾©ä¸‰ç¨® DAG çµæ§‹
# Confounder
dag_confounder <- dagify(
  Y ~ A + C,
  A ~ C,
  coords = list(x = c(A = 0, C = 1, Y = 2), y = c(A = 0, C = 1, Y = 0)),
  labels = c(A = "æ²»ç™‚", C = "å¹´é½¡", Y = "çµæœ")
)

# Mediator
dag_mediator <- dagify(
  Y ~ M,
  M ~ A,
  coords = list(x = c(A = 0, M = 1, Y = 2), y = c(A = 0, M = 0, Y = 0)),
  labels = c(A = "é™å£“è—¥", M = "è¡€å£“â†“", Y = "å¿ƒè¡€ç®¡äº‹ä»¶â†“")
)

# Collider
dag_collider <- dagify(
  C ~ A + U,
  Y ~ U,
  coords = list(
    x = c(A = 0, C = 1, U = 2, Y = 2),
    y = c(A = 1, C = 0, U = 1, Y = 0)
  ),
  labels = c(A = "æ²»ç™‚", C = "ä½é™¢", U = "åš´é‡åº¦", Y = "çµæœ")
)

# ç¹ªè£½å‡½æ•¸
plot_dag <- function(dag, title, adjust_color = "gray80") {
  ggdag(dag, text = FALSE, use_labels = "label") +
    geom_dag_point(color = colors$accent, size = 18) +
    geom_dag_text(color = "white", size = 3.5, family = "openhuninn") +
    geom_dag_edges(edge_width = 1) +
    labs(title = title) +
    theme_dag() +
    theme(
      plot.title = element_text(
        hjust = 0.5,
        size = 14,
        face = "bold",
        family = "openhuninn"
      )
    )
}

p1 <- plot_dag(dag_confounder, "æ··æ·†å› å­ (Confounder)\nâœ… è©²èª¿æ•´")
p2 <- plot_dag(dag_mediator, "ä¸­ä»‹è®Šæ•¸ (Mediator)\nâŒ ä¸è©²èª¿æ•´")
p3 <- plot_dag(dag_collider, "ç¢°æ’è®Šæ•¸ (Collider)\nâŒ ä¸è©²èª¿æ•´")

p1 + p2 + p3
```

::: {.fragment}
**é—œéµ**ï¼šç”¨ DAG æƒ³æ¸…æ¥šè®Šæ•¸ä¹‹é–“çš„é—œä¿‚ï¼Œå†æ±ºå®šèª¿æ•´ä»€éº¼
:::

## ç‚ºä»€éº¼èª¿æ•´éŒ¯è®Šæ•¸å¾ˆå±éšªï¼Ÿ

::: {.columns}
::: {.column width="50%"}
**èª¿æ•´ä¸­ä»‹è®Šæ•¸**

```{mermaid}
%%| fig-width: 4
flowchart LR
    A[é™å£“è—¥] --> M[è¡€å£“â†“]
    M --> Y[å¿ƒè¡€ç®¡äº‹ä»¶â†“]
```

èª¿æ•´è¡€å£“ â†’ æŠŠè—¥æ•ˆã€Œèª¿æ‰ã€äº†ï¼
:::
::: {.column width="50%"}
**èª¿æ•´ç¢°æ’è®Šæ•¸**

```{mermaid}
%%| fig-width: 4
flowchart TD
    A[æ²»ç™‚] --> C[ä½é™¢]
    U[æœªæ¸¬é‡å› å­] --> C
    U --> Y[çµæœ]
```

èª¿æ•´ä½é™¢ â†’ æ‰“é–‹å¾Œé–€ã€å¼•å…¥åèª¤ï¼
:::
:::

## èª¿æ•´ä»€éº¼ï¼Ÿ

| è®Šæ•¸é¡å‹ | èª¿æ•´ï¼Ÿ | åŸå›  |
|:---------|:------:|:-----|
| æ··æ·†å› å­ | âœ… | é˜»æ–·å¾Œé–€è·¯å¾‘ |
| ä¸­ä»‹è®Šæ•¸ | âŒ | æœƒç§»é™¤æ²»ç™‚æ•ˆæœ |
| ç¢°æ’è®Šæ•¸ | âŒ | æœƒæ‰“é–‹æ–°çš„åèª¤è·¯å¾‘ |
| å·¥å…·è®Šæ•¸ | âŒ | åªå½±éŸ¿æ²»ç™‚ï¼Œä¸ç›´æ¥å½±éŸ¿çµæœ |

::: {.fragment}
### å¯¦å‹™å»ºè­°

> ç•«å‡º DAGï¼Œæ ¹æ“šå› æœçµæ§‹æ±ºå®šèª¿æ•´å“ªäº›è®Šæ•¸ï¼Œè€Œéã€ŒæŠŠæ‰€æœ‰è®Šæ•¸éƒ½ä¸Ÿé€²å»ã€
:::

## èª¿æ•´å° vs èª¿æ•´éŒ¯ï¼šæ¨¡æ“¬æ¯”è¼ƒ

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 5

set.seed(42)
n <- 1000

# æ¨¡æ“¬è³‡æ–™ï¼šçœŸå¯¦æ•ˆæœæ˜¯ -5
# æƒ…å¢ƒ 1ï¼šæœ‰ confounder æœªèª¿æ•´ -> æœ‰åèª¤
# æƒ…å¢ƒ 2ï¼šèª¿æ•´ confounder -> æ­£ç¢º
# æƒ…å¢ƒ 3ï¼šèª¿æ•´ mediator -> æ•ˆæœè®Šå°
# æƒ…å¢ƒ 4ï¼šèª¿æ•´ collider -> ç”¢ç”Ÿåèª¤

true_effect <- -5

# æ¨¡æ“¬ä¼°è¨ˆå€¼å’Œä¿¡è³´å€é–“
results <- data.frame(
  scenario = factor(
    c(
      "æœªèª¿æ•´\nï¼ˆåŸå§‹å·®ç•°ï¼‰",
      "èª¿æ•´æ··æ·†å› å­\nï¼ˆæ­£ç¢ºåšæ³•ï¼‰",
      "èª¿æ•´ä¸­ä»‹è®Šæ•¸\nï¼ˆéŒ¯èª¤ï¼šæ•ˆæœæ¶ˆå¤±ï¼‰",
      "èª¿æ•´ç¢°æ’è®Šæ•¸\nï¼ˆéŒ¯èª¤ï¼šåèª¤ï¼‰"
    ),
    levels = c(
      "æœªèª¿æ•´\nï¼ˆåŸå§‹å·®ç•°ï¼‰",
      "èª¿æ•´æ··æ·†å› å­\nï¼ˆæ­£ç¢ºåšæ³•ï¼‰",
      "èª¿æ•´ä¸­ä»‹è®Šæ•¸\nï¼ˆéŒ¯èª¤ï¼šæ•ˆæœæ¶ˆå¤±ï¼‰",
      "èª¿æ•´ç¢°æ’è®Šæ•¸\nï¼ˆéŒ¯èª¤ï¼šåèª¤ï¼‰"
    )
  ),
  estimate = c(-8.5, -5.1, -1.2, -7.8),
  ci_lo = c(-10.2, -6.5, -2.8, -9.5),
  ci_hi = c(-6.8, -3.7, 0.4, -6.1),
  correct = c(FALSE, TRUE, FALSE, FALSE)
)

ggplot(results, aes(x = scenario, y = estimate, color = correct)) +
  geom_hline(
    yintercept = true_effect,
    linetype = "dashed",
    color = colors$accent,
    linewidth = 1.2
  ) +
  geom_hline(yintercept = 0, color = "gray50") +
  geom_pointrange(
    aes(ymin = ci_lo, ymax = ci_hi),
    size = 1.2,
    linewidth = 1.2
  ) +
  geom_text(
    aes(label = sprintf("%.1f", estimate)),
    vjust = -1.5,
    size = 5,
    family = "openhuninn",
    show.legend = FALSE
  ) +
  scale_color_manual(
    values = c("TRUE" = colors$robust, "FALSE" = colors$fragile),
    labels = c("TRUE" = "æ­£ç¢º", "FALSE" = "æœ‰åèª¤"),
    name = ""
  ) +
  annotate(
    "text",
    x = 4.4,
    y = true_effect,
    label = "çœŸå¯¦æ•ˆæœ",
    hjust = 0,
    vjust = -0.5,
    family = "openhuninn",
    color = colors$accent,
    size = 4
  ) +
  labs(
    x = "",
    y = "ä¼°è¨ˆçš„æ²»ç™‚æ•ˆæœ",
    title = "ä¸åŒèª¿æ•´ç­–ç•¥çš„çµæœ"
  ) +
  coord_cartesian(ylim = c(-12, 2)) +
  theme_causal() +
  theme(
    axis.text.x = element_text(size = 11),
    legend.position = "top"
  )
```

::: {.fragment}
**çµè«–**ï¼šèª¿æ•´éŒ¯èª¤çš„è®Šæ•¸ï¼Œæ¯”ä¸èª¿æ•´é‚„ç³Ÿç³•ï¼
:::

## ä¸‰å¤§å› æœå‡è¨­

| å‡è¨­ | ç™½è©±æ„æ€ | æ€éº¼è™•ç† |
|------|----------|----------|
| ä¸€è‡´æ€§ | æ²»ç™‚å®šç¾©è¦æ˜ç¢º | ç ”ç©¶è¨­è¨ˆ |
| å¯äº¤æ›æ€§ | æ²’æœ‰æœªæ¸¬é‡æ··æ·† | èª¿æ•´ + æ•æ„Ÿåº¦åˆ†æ |
| æ­£å€¼æ€§ | æ¯ç¨®äººéƒ½æœ‰æ©Ÿæœƒæ¥å—å„æ²»ç™‚ | æª¢æŸ¥ PS åˆ†å¸ƒ |

## å°çµï¼šç ”ç©¶è¨­è¨ˆæ€ç¶­

::: {.incremental}
1. ç”¨ **Target Trial** æ¡†æ¶å®šç¾©ä½ çš„ç ”ç©¶å•é¡Œ
2. ç”¨ **DAG** ç•«å‡ºè®Šæ•¸ä¹‹é–“çš„å› æœé—œä¿‚
3. åªèª¿æ•´ **æ··æ·†å› å­**ï¼Œä¸èª¿æ•´ä¸­ä»‹è®Šæ•¸å’Œç¢°æ’è®Šæ•¸
4. ç¢ºèªä¸‰å¤§å‡è¨­æ˜¯å¦åˆç†
:::

::: {.fragment}
> **ä¸‹ä¸€æ­¥**ï¼šè¨­è¨ˆå¥½äº†ï¼Œé‚£å…·é«”è¦ç”¨ä»€éº¼çµ±è¨ˆæ–¹æ³•å‘¢ï¼Ÿ
:::

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ–¹æ³•æ¦‚å¿µ {data-stack-name="æ–¹æ³•æ¦‚å¿µ"}

## æœ¬ç¯€é‡é»

ç¾åœ¨æˆ‘å€‘çŸ¥é“è¦èª¿æ•´æ··æ·†å› å­ï¼Œä½†**æ€éº¼èª¿æ•´**ï¼Ÿ

::: {.incremental}
- å‚³çµ±æ–¹æ³•æœ‰ä»€éº¼å•é¡Œï¼Ÿ
- ä»€éº¼æ˜¯ã€Œå‚¾å‘åˆ†æ•¸ã€ï¼Ÿ
- ç‚ºä»€éº¼æ¨è–¦ã€Œé›™é‡ç©©å¥ã€æ–¹æ³•ï¼Ÿ
:::

## å‚¾å‘åˆ†æ•¸ (Propensity Score)

**ç™½è©±**ï¼šã€Œæ ¹æ“šç—…äººç‰¹å¾µï¼Œé æ¸¬ä»–æ¥å—æ²»ç™‚çš„æ©Ÿç‡ã€

::: {.fragment}
**ç”¨é€”**ï¼šè®“å…©çµ„è®Šå¾—å¯æ¯”è¼ƒ
:::

## PS æ˜¯æ€éº¼ç®—å‡ºä¾†çš„ï¼Ÿ

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 5

set.seed(123)
n <- 200

# æ¨¡æ“¬ç—…äººè³‡æ–™
age <- round(rnorm(n, 60, 10))
severity <- plogis(-2 + 0.05 * age + rnorm(n, 0, 0.5))

# çœŸå¯¦çš„ PS æ¨¡å‹
true_ps <- plogis(-3 + 0.04 * age + 2 * severity)
treatment <- rbinom(n, 1, true_ps)

df_ps <- data.frame(
  age = age,
  severity = severity,
  true_ps = true_ps,
  treatment = factor(treatment, labels = c("å°ç…§çµ„", "æ²»ç™‚çµ„"))
)

# ç•«å‡º PS èˆ‡å¹´é½¡/åš´é‡åº¦çš„é—œä¿‚
library(patchwork)

p1 <- ggplot(df_ps, aes(x = age, y = true_ps, color = treatment)) +
  geom_point(alpha = 0.6, size = 2.5) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 1.5, color = "gray30") +
  scale_color_manual(
    values = c("æ²»ç™‚çµ„" = colors$treatment, "å°ç…§çµ„" = colors$control)
  ) +
  labs(
    x = "å¹´é½¡",
    y = "Propensity Score",
    color = "",
    title = "å¹´é½¡ â†’ PS"
  ) +
  theme_causal(base_size = 14) +
  theme(legend.position = "none")

p2 <- ggplot(df_ps, aes(x = severity, y = true_ps, color = treatment)) +
  geom_point(alpha = 0.6, size = 2.5) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 1.5, color = "gray30") +
  scale_color_manual(
    values = c("æ²»ç™‚çµ„" = colors$treatment, "å°ç…§çµ„" = colors$control)
  ) +
  labs(
    x = "åš´é‡åº¦",
    y = "Propensity Score",
    color = "",
    title = "åš´é‡åº¦ â†’ PS"
  ) +
  theme_causal(base_size = 14)

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "top")
```

::: {.fragment}
**æ ¸å¿ƒ**ï¼šPS æŠŠå¤šå€‹å…±è®Šé‡å£“ç¸®æˆä¸€å€‹åˆ†æ•¸ï¼Œä»£è¡¨ã€Œé€™å€‹äººè¢«æ²»ç™‚çš„æ©Ÿç‡ã€
:::

## Demo

```{r}
#| echo: false
#| fig-width: 8
#| fig-height: 4

set.seed(42)
n <- 500

# Simulate PS with different distributions for treated vs control
ps_treated <- rbeta(n, 5, 2) # Higher PS for treated
ps_control <- rbeta(n, 2, 5) # Lower PS for control

df <- data.frame(
  ps = c(ps_treated, ps_control),
  group = factor(rep(c("æ²»ç™‚çµ„", "å°ç…§çµ„"), each = n))
)

ggplot(df, aes(x = ps, fill = group)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(
    values = c("æ²»ç™‚çµ„" = colors$treatment, "å°ç…§çµ„" = colors$control)
  ) +
  labs(
    x = "Propensity Score",
    y = "Density",
    fill = ""
  ) +
  theme_causal()
```

::: {.fragment}
**é‡ç–Šå€åŸŸ**ï¼šå…©çµ„å¯æ¯”è¼ƒçš„ç¯„åœ
:::

## å‚³çµ±æ–¹æ³•çš„å•é¡Œ

| æ–¹æ³• | åšæ³• | é¢¨éšª |
|------|------|------|
| å–®ç´”è¿´æ­¸èª¿æ•´ | æŠŠæ··æ·†å› å­ä¸Ÿé€²æ¨¡å‹ | æ¨¡å‹è¨­éŒ¯å°±å®Œäº† |
| PS matching | ç”¨ PS é…å° | ä¸Ÿæ‰å¾ˆå¤šæ¨£æœ¬ |
| PS weighting (IPW) | ç”¨ PS åŠ æ¬Š | æ¥µç«¯æ¬Šé‡ä¸ç©©å®š |

::: {.callout-note appearance="minimal"}
## åè©è§£é‡‹
- **PS matching**ï¼šæ‰¾ PS ç›¸è¿‘çš„æ²»ç™‚çµ„èˆ‡å°ç…§çµ„ç—…äººé…å°æ¯”è¼ƒ
- **IPW (Inverse Probability Weighting)**ï¼šç”¨ 1/PS ç•¶æ¬Šé‡ï¼Œè®“å…©çµ„ã€Œäººå·¥å¹³è¡¡ã€
:::

## âš ï¸ ç‚ºä»€éº¼ä¸æ¨è–¦å–®ç¨ç”¨ IPWï¼Ÿ

::: {.columns}
::: {.column width="50%"}
**IPW çš„å•é¡Œ**

ç•¶ PS æ¥è¿‘ 0 æˆ– 1 æ™‚ï¼š

- æ¬Šé‡ = 1/PS æœƒ**çˆ†ç‚¸**
- å°‘æ•¸äººä¸»å°æ•´å€‹ä¼°è¨ˆ
- æ–¹å·®å·¨å¤§ã€ä¼°è¨ˆé£„å‹•
:::
::: {.column width="50%"}
**å¯¦éš›æƒ…æ³**

å¹¾ç™¾ä¾‹çš„è‡¨åºŠè³‡æ–™ï¼š

- å¾ˆå¸¸é‡åˆ°é‡ç–Šä¸ä½³
- æŸäº›ç—…äºº PS å¾ˆæ¥µç«¯
- IPW æœƒéå¸¸ä¸ç©©å®š
:::
:::

::: {.fragment}
### çµè«–

> IPW å¯ä»¥ç•¶**æ•æ„Ÿåº¦åˆ†æ**ï¼Œä½†ä¸å»ºè­°ç•¶**ä¸»åˆ†æ**
:::

## IPW æ¬Šé‡çš„å±éšªï¼šæ¥µç«¯å€¼

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 5

set.seed(456)
n <- 500

# æ¨¡æ“¬ä¸€äº›æ¥µç«¯çš„ PS å€¼
ps_values <- c(
  rbeta(n * 0.7, 3, 3), # å¤§å¤šæ•¸äºº PS åœ¨ä¸­é–“
  rbeta(n * 0.15, 0.5, 5), # ä¸€äº›äºº PS å¾ˆä½
  rbeta(n * 0.15, 5, 0.5) # ä¸€äº›äºº PS å¾ˆé«˜
)
ps_values <- pmax(0.01, pmin(0.99, ps_values))

# è¨ˆç®— IPW æ¬Šé‡ï¼ˆç°¡åŒ–ç‰ˆï¼šå‡è¨­éƒ½æ˜¯æ²»ç™‚çµ„ï¼‰
treatment <- rbinom(length(ps_values), 1, ps_values)
ipw_weights <- ifelse(treatment == 1, 1 / ps_values, 1 / (1 - ps_values))

df_ipw <- data.frame(
  ps = ps_values,
  weight = ipw_weights,
  treatment = factor(treatment, labels = c("å°ç…§çµ„", "æ²»ç™‚çµ„")),
  extreme = ifelse(ipw_weights > 10, "æ¥µç«¯æ¬Šé‡ (>10)", "æ­£å¸¸")
)

# çµ±è¨ˆ
n_extreme <- sum(df_ipw$extreme == "æ¥µç«¯æ¬Šé‡ (>10)")
pct_extreme <- round(100 * n_extreme / nrow(df_ipw), 1)

p1 <- ggplot(df_ipw, aes(x = weight, fill = extreme)) +
  geom_histogram(bins = 50, color = "white", linewidth = 0.2) +
  geom_vline(
    xintercept = 10,
    linetype = "dashed",
    color = colors$fragile,
    linewidth = 1.2
  ) +
  scale_fill_manual(
    values = c("æ¥µç«¯æ¬Šé‡ (>10)" = colors$fragile, "æ­£å¸¸" = colors$control),
    name = ""
  ) +
  scale_x_continuous(limits = c(0, 50)) +
  annotate(
    "text",
    x = 12,
    y = Inf,
    label = paste0(n_extreme, " äºº (", pct_extreme, "%)\næ¬Šé‡ > 10"),
    hjust = 0,
    vjust = 1.5,
    family = "openhuninn",
    color = colors$fragile,
    size = 4
  ) +
  annotate(
    "text",
    x = 2,
    y = Inf,
    label = "å¤§å¤šæ•¸äºº\næ¬Šé‡æ­£å¸¸",
    hjust = 0,
    vjust = 1.5,
    family = "openhuninn",
    color = colors$control,
    size = 4
  ) +
  labs(
    x = "IPW æ¬Šé‡",
    y = "äººæ•¸",
    title = "IPW æ¬Šé‡åˆ†å¸ƒ"
  ) +
  theme_causal(base_size = 14)

p2 <- ggplot(df_ipw, aes(x = ps, y = weight, color = extreme)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_hline(
    yintercept = 10,
    linetype = "dashed",
    color = colors$fragile,
    linewidth = 1
  ) +
  scale_color_manual(
    values = c("æ¥µç«¯æ¬Šé‡ (>10)" = colors$fragile, "æ­£å¸¸" = colors$control),
    name = ""
  ) +
  scale_y_continuous(limits = c(0, 50)) +
  annotate(
    "text",
    x = 0.05,
    y = 45,
    label = "PS æ¥è¿‘ 0\næ¬Šé‡ = 1/(1-PS) çˆ†ç‚¸",
    hjust = 0,
    vjust = 1,
    family = "openhuninn",
    color = colors$fragile,
    size = 3.5
  ) +
  annotate(
    "text",
    x = 0.85,
    y = 45,
    label = "PS æ¥è¿‘ 1\næ¬Šé‡ = 1/PS çˆ†ç‚¸",
    hjust = 0,
    vjust = 1,
    family = "openhuninn",
    color = colors$fragile,
    size = 3.5
  ) +
  annotate(
    "curve",
    x = 0.1, xend = 0.03,
    y = 38, yend = 30,
    curvature = 0.3,
    arrow = arrow(length = unit(0.2, "cm")),
    color = colors$fragile
  ) +
  annotate(
    "curve",
    x = 0.9, xend = 0.97,
    y = 38, yend = 30,
    curvature = -0.3,
    arrow = arrow(length = unit(0.2, "cm")),
    color = colors$fragile
  ) +
  labs(
    x = "Propensity Score",
    y = "IPW æ¬Šé‡",
    title = "PS æ¥µç«¯ â†’ æ¬Šé‡çˆ†ç‚¸"
  ) +
  theme_causal(base_size = 14)

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "top")
```

::: {.fragment}
**å•é¡Œ**ï¼šå°‘æ•¸æ¥µç«¯æ¬Šé‡çš„äººï¼Œä¸»å°äº†æ•´å€‹ä¼°è¨ˆçµæœï¼
:::

## é›™é‡ç©©å¥ä¼°è¨ˆï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰

::: {.callout-tip appearance="minimal"}
## ä»€éº¼æ˜¯ã€Œé›™é‡ç©©å¥ã€(Doubly Robust)ï¼Ÿ
åŒæ™‚ç”¨å…©å€‹æ¨¡å‹ä¾†ä¼°è¨ˆå› æœæ•ˆæ‡‰ï¼Œåªè¦å…¶ä¸­ä¸€å€‹æ¨¡å‹æ­£ç¢ºï¼Œçµæœå°±ä¸æœƒæœ‰åèª¤ã€‚å°±åƒè²·å…©ä»½ä¿éšªï¼
:::

::: {.incremental}
- åŒæ™‚å»ºå…©å€‹æ¨¡å‹ï¼šPS æ¨¡å‹ + çµæœæ¨¡å‹
- å¥½è™•ï¼šåªè¦å…¶ä¸­ä¸€å€‹å°ï¼Œçµæœå°±å°
- ã€Œè²·ä¿éšªã€çš„æ¦‚å¿µ
:::

## TMLE vs AIPW

::: {.callout-note appearance="minimal"}
## åè©è§£é‡‹
- **TMLE** (Targeted Maximum Likelihood Estimation)ï¼šé‡å°ã€Œä½ æƒ³ä¼°è¨ˆçš„æ±è¥¿ã€åšæœ€ä½³åŒ–çš„é›™é‡ç©©å¥æ–¹æ³•
- **AIPW** (Augmented IPW)ï¼šåœ¨ IPW åŸºç¤ä¸ŠåŠ å…¥çµæœæ¨¡å‹ä¿®æ­£çš„é›™é‡ç©©å¥æ–¹æ³•
:::

::: {.columns}
::: {.column width="50%"}
**å…±åŒé»**

- éƒ½æ˜¯é›™é‡ç©©å¥
:::
::: {.column width="50%"}
**TMLE å„ªå‹¢**

- å¤šä¸€å€‹ targeting æ­¥é©Ÿ
- æ›´ç©©å®š
:::
:::

::: {.fragment}
**å¯¦å‹™ä¸Šï¼šé¸ TMLE å°±å°äº†**
:::

## é›™é‡ç©©å¥ï¼šã€ŒéŒ¯ä¸€å€‹ä¹Ÿæ²’é—œä¿‚ã€

```{r}
#| echo: false
#| fig-width: 9
#| fig-height: 5

# å»ºç«‹ 2x2 æƒ…å¢ƒè¡¨
dr_scenarios <- data.frame(
  ps_model = rep(c("PS æ¨¡å‹\næ­£ç¢º", "PS æ¨¡å‹\néŒ¯èª¤"), each = 2),
  outcome_model = rep(c("Outcome æ¨¡å‹æ­£ç¢º", "Outcome æ¨¡å‹éŒ¯èª¤"), 2),
  result = c("ç„¡åèª¤", "ç„¡åèª¤", "ç„¡åèª¤", "æœ‰åèª¤"),
  color = c("robust", "robust", "robust", "fragile")
)

dr_scenarios$ps_model <- factor(
  dr_scenarios$ps_model,
  levels = c("PS æ¨¡å‹\næ­£ç¢º", "PS æ¨¡å‹\néŒ¯èª¤")
)
dr_scenarios$outcome_model <- factor(
  dr_scenarios$outcome_model,
  levels = c("Outcome æ¨¡å‹æ­£ç¢º", "Outcome æ¨¡å‹éŒ¯èª¤")
)

ggplot(dr_scenarios, aes(x = outcome_model, y = ps_model, fill = color)) +
  geom_tile(color = "white", linewidth = 3) +
  geom_text(
    aes(label = result),
    size = 8,
    family = "openhuninn",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = c("robust" = colors$robust, "fragile" = colors$fragile),
    guide = "none"
  ) +
  labs(
    x = "",
    y = "",
    title = "é›™é‡ç©©å¥ï¼š4 ç¨®æƒ…å¢ƒä¸­ 3 ç¨®éƒ½ OK"
  ) +
  theme_causal() +
  theme(
    axis.text = element_text(size = 14, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 18),
    panel.grid = element_blank()
  )
```

::: {.fragment}
**é—œéµå„ªå‹¢**ï¼šåªæœ‰ç•¶ã€Œå…©å€‹æ¨¡å‹éƒ½éŒ¯ã€æ™‚æ‰æœƒæœ‰åèª¤ â†’ å¤§å¤§é™ä½é¢¨éšª
:::

## ä½†å•é¡Œä¾†äº†...

::: {.callout-warning appearance="minimal"}
## é›™é‡ç©©å¥çš„å‰æ
ã€Œè‡³å°‘ä¸€å€‹æ¨¡å‹è¦å°ã€â€” ä½†æˆ‘å€‘æ€éº¼ç¢ºä¿ï¼Ÿ
:::

:::: {.columns}

::: {.column width="50%"}
**å‚³çµ±åšæ³•**

1. æ‰‹å‹•é¸ä¸€å€‹æ¨¡å‹ï¼ˆå¦‚ logisticï¼‰
2. å‡è¨­å‡½æ•¸å½¢å¼æ­£ç¢º
3. ç¥ˆç¦±æ²’é¸éŒ¯
:::

::: {.column width="50%"}
**å•é¡Œ**

- çœŸå¯¦é—œä¿‚å¯èƒ½æ˜¯éç·šæ€§çš„
- å¯èƒ½æœ‰äº¤äº’ä½œç”¨
- é¸éŒ¯äº† â†’ å…©å€‹æ¨¡å‹éƒ½éŒ¯ â†’ åèª¤ï¼
:::

::::

::: {.fragment}
> **è§£æ³•**ï¼šè®“è³‡æ–™è‡ªå·±æ±ºå®šç”¨å“ªå€‹æ¨¡å‹ â†’ **Super Learner**
:::

## Super Learnerï¼ˆä¸€å¥è©±è§£é‡‹ï¼‰

::: {.callout-note appearance="minimal"}
## ä»€éº¼æ˜¯ Super Learnerï¼Ÿ
ä¸€ç¨®ã€Œæ¨¡å‹çµ„åˆã€æŠ€è¡“ï¼šåŒæ™‚è·‘å¤šå€‹æ©Ÿå™¨å­¸ç¿’æ¨¡å‹ï¼Œç”¨äº¤å‰é©—è­‰æ‰¾å‡ºæœ€ä½³åŠ æ¬Šçµ„åˆã€‚
:::

- ä¸ç”¨æ‰‹å‹•é¸æ¨¡å‹ï¼Œè®“æ¼”ç®—æ³•è‡ªå‹•æ‰¾æœ€ä½³çµ„åˆ
- å¤§å¹…é™ä½ã€Œå…©å€‹æ¨¡å‹éƒ½éŒ¯ã€çš„æ©Ÿç‡
- é€™å°±æ˜¯ç‚ºä»€éº¼ç¾ä»£å› æœæ¨è«–éƒ½ç”¨ TMLE + Super Learner

## Super Learner åº«çš„é¸æ“‡

::: {.callout-warning appearance="minimal"}
## å°æ¨£æœ¬åŸå‰‡
åº«è¦**å°ä¸”ä¿å®ˆ**ï¼Œä¸è¦è¿½æ±‚è¤‡é›œï¼
:::

:::: {.columns}

::: {.column width="50%"}
**æ¨è–¦çš„å€™é¸æ¨¡å‹**

- `SL.glm`ï¼šæ¨™æº– logistic/ç·šæ€§
- `SL.glmnet`ï¼šæ­£å‰‡åŒ–ï¼ˆridge/lassoï¼‰
- `SL.gam`ï¼šå¹³æ»‘éç·šæ€§
- `SL.ranger`ï¼šï¼ˆäº‹ä»¶æ•¸å¤ æ‰åŠ ï¼‰
:::

::: {.column width="50%"}
**å°æ¨£æœ¬è¦é¿å…**

- æ·±æ¨¹ random forest
- å¤§è¦æ¨¡ boosting
- è¤‡é›œè¶…åƒæ•¸æœå°‹
- å¤ªå¤šå€™é¸æ¨¡å‹
:::

::::

## Super Learner åº«ï¼šå¯¦ä¾‹é¸æ“‡

| æƒ…å¢ƒ | äº‹ä»¶æ•¸ | æ¨è–¦çš„åº« |
|------|--------|----------|
| ç½•è¦‹ç–¾ç—… RCT | 30-50 | `SL.glm`, `SL.glmnet` |
| ä¸€èˆ¬è‡¨åºŠç ”ç©¶ | 50-200 | `SL.glm`, `SL.glmnet`, `SL.gam` |
| å¤§å‹å¥ä¿è³‡æ–™åº« | 500+ | ä¸Šè¿° + `SL.ranger`, `SL.xgboost` |
| è¶…å¤§è³‡æ–™ | 5000+ | å¯åŠ æ›´å¤šå½ˆæ€§æ¨¡å‹ |

::: {.fragment}
::: {.callout-tip appearance="minimal"}
## ç¶“é©—æ³•å‰‡
äº‹ä»¶æ•¸ Ã· 10 â‰ˆ å¯ç”¨çš„å€™é¸æ¨¡å‹æ•¸ä¸Šé™
:::
:::

## ä½¿ç”¨ ML æ¨¡å‹çš„éš±æ†‚

::: {.callout-warning appearance="minimal"}
## å•é¡Œ
Super Learner ç”¨äº†å½ˆæ€§çš„æ©Ÿå™¨å­¸ç¿’æ¨¡å‹ï¼Œä½†é€™æœƒå¸¶ä¾†ä¸€å€‹çµ±è¨ˆå•é¡Œ...
:::

:::: {.columns}

::: {.column width="50%"}
**å‚³çµ±è¿´æ­¸**

- æ¨¡å‹ç°¡å–®ã€åƒæ•¸å°‘
- ç”¨åŒä¸€ç­†è³‡æ–™æ“¬åˆ + æ¨è«– â†’ OK
:::

::: {.column width="50%"}
**æ©Ÿå™¨å­¸ç¿’æ¨¡å‹**

- æ¨¡å‹è¤‡é›œã€å®¹æ˜“éæ“¬åˆ
- ç”¨åŒä¸€ç­†è³‡æ–™æ“¬åˆ + æ¨è«– â†’ æ¨™æº–èª¤æœƒåå°ã€ä¿¡è³´å€é–“ä¸å¯é 
:::

::::

::: {.fragment}
> **ç™½è©±èªª**ï¼šæ¨¡å‹ã€Œè¨˜ä½ã€äº†è³‡æ–™çš„å™ªéŸ³ï¼Œå°è‡´æˆ‘å€‘å°æ•ˆæœä¼°è¨ˆéåº¦è‡ªä¿¡
:::

## Cross-Fittingï¼ˆäº¤å‰æ“¬åˆï¼‰

::: {.callout-tip appearance="minimal"}
## è§£æ³•
ç”¨**ä¸åŒçš„è³‡æ–™**ä¾†æ“¬åˆæ¨¡å‹å’Œä¼°è¨ˆæ•ˆæ‡‰ â†’ é¿å…éæ“¬åˆå½±éŸ¿æ¨è«–
:::

**åšæ³•**ï¼š

::: {.incremental}
1. æŠŠè³‡æ–™åˆ†æˆ K æŠ˜ï¼ˆå¹¾ç™¾ä¾‹å»ºè­° **2-fold**ï¼‰
2. ç”¨ K-1 æŠ˜æ“¬åˆæ¨¡å‹
3. ç”¨å‰©ä¸‹ 1 æŠ˜é æ¸¬
4. è¼ªæµåšï¼Œæœ€å¾Œåˆä½µ
:::

::: {.fragment}
`tmle3` å’Œ `ltmle` å¥—ä»¶æœƒè‡ªå‹•å¹«ä½ åšï¼
:::

## PS æˆªæ–·ï¼ˆTruncationï¼‰

::: {.callout-warning appearance="minimal"}
## å•é¡Œ
PS å¤ªæ¥è¿‘ 0 æˆ– 1 æ™‚ï¼Œæ¬Šé‡æœƒçˆ†ç‚¸
:::

**è§£æ³•**ï¼šæŠŠ PS é™åˆ¶åœ¨åˆç†ç¯„åœ

```r
# å¸¸è¦‹æˆªæ–·ç¯„åœ
ps_truncated <- pmax(0.01, pmin(0.99, ps)) # å¯¬é¬†
ps_truncated <- pmax(0.05, pmin(0.95, ps)) # ä¿å®ˆ
```

::: {.callout-important appearance="minimal"}
## é‡è¦æé†’
æˆªæ–·ç¯„åœè¦**é å…ˆå®£å‘Š**ï¼Œä¸è¦äº‹å¾Œèª¿åƒï¼ˆé¿å… p-hacking å«Œç–‘ï¼‰
:::

## å°çµï¼šæ–¹æ³•æ¦‚å¿µ

åˆ°ç›®å‰ç‚ºæ­¢ï¼Œæˆ‘å€‘å­¸äº†ï¼š

| æ¦‚å¿µ | é‡é» |
|------|------|
| å‚¾å‘åˆ†æ•¸ (PS) | é æ¸¬æ¥å—æ²»ç™‚çš„æ©Ÿç‡ï¼Œè®“å…©çµ„å¯æ¯” |
| é›™é‡ç©©å¥ | å…©å€‹æ¨¡å‹ï¼ŒéŒ¯ä¸€å€‹ä¹Ÿæ²’é—œä¿‚ |
| TMLE | æœ€æ¨è–¦çš„é›™é‡ç©©å¥æ–¹æ³• |
| Super Learner | è‡ªå‹•é¸æœ€ä½³æ¨¡å‹çµ„åˆ |

::: {.fragment}
> **ä¸‹ä¸€æ­¥**ï¼šä¸åŒé¡å‹çš„çµæœè®Šæ•¸ï¼Œè¦ç”¨ä»€éº¼æ–¹æ³•ï¼Ÿ
:::

# ç¬¬å››éƒ¨åˆ†ï¼šæƒ…å¢ƒé¸æ“‡èœå–® {data-stack-name="æ–¹æ³•é¸æ“‡"}

## æœ¬ç¯€é‡é»

ä½ çš„ç ”ç©¶çµæœæ˜¯ä»€éº¼é¡å‹ï¼Ÿ

- é€£çºŒè®Šæ•¸ï¼Ÿï¼ˆè¡€å£“ã€HbA1cï¼‰
- äºŒå…ƒè®Šæ•¸ï¼Ÿï¼ˆæ­»äº¡ Y/Nï¼‰
- å­˜æ´»æ™‚é–“ï¼Ÿï¼ˆæ­»äº¡æ™‚é–“ï¼‰

::: {.fragment}
**ä¸åŒé¡å‹ â†’ ä¸åŒæ–¹æ³• â†’ ä¸åŒ R å¥—ä»¶**
:::

## ä¸€å¼µè¡¨æå®šæ–¹æ³•é¸æ“‡

| Outcome é¡å‹ | ç¯„ä¾‹ | ä¼°è¨ˆä»€éº¼ | R å¥—ä»¶ |
|--------------|------|----------|--------|
| é€£çºŒ | è¡€å£“ã€HbA1c | å¹³å‡å·® | `tmle` |
| äºŒå…ƒ | æ­»äº¡ Y/N | Risk Diff / RR | `tmle` |
| å­˜æ´» | æ­»äº¡æ™‚é–“ | Survival diff | `survtmle` |
| è¨ˆæ•¸ | ä½é™¢æ¬¡æ•¸ | Rate Ratio | `WeightIt` |
| é‡è¤‡æ¸¬é‡ | å¤šæ™‚é–“é»è¿½è¹¤ | è»Œè·¡å·®ç•° | `geepack` |

## Estimand çš„é¸æ“‡

::: {.callout-note appearance="minimal"}
## åè©è§£é‡‹
- **Estimand**ï¼šä½ æƒ³ä¼°è¨ˆçš„ã€Œç›®æ¨™é‡ã€ï¼Œè¦å…ˆå®šç¾©æ¸…æ¥šæ‰èƒ½é¸æ–¹æ³•
- **ATE** (Average Treatment Effect)ï¼šå¦‚æœè®“ã€Œæ‰€æœ‰äººã€éƒ½æ¥å—æ²»ç™‚ vs éƒ½ä¸æ¥å—ï¼Œå¹³å‡å·®ç•°æ˜¯å¤šå°‘ï¼Ÿ
- **ATT** (Average Treatment Effect on the Treated)ï¼šå°æ–¼ã€Œå¯¦éš›æ¥å—æ²»ç™‚çš„äººã€ï¼Œæ²»ç™‚æ•ˆæœæ˜¯å¤šå°‘ï¼Ÿ
:::

## ATE vs ATTï¼šä»€éº¼æ™‚å€™ç”¨å“ªå€‹ï¼Ÿ

::: {.columns}
::: {.column width="50%"}
**ATEï¼ˆå…¨é«”å¹³å‡æ•ˆæœï¼‰**

- å•ï¼šã€Œå¦‚æœæ”¿ç­–æ¨å»£çµ¦æ‰€æœ‰äººã€
- éœ€è¦å…©çµ„**å……åˆ†é‡ç–Š**
- æ¨£æœ¬å°ã€é‡ç–Šå·®æ™‚**å¾ˆä¸ç©©å®š**
:::
::: {.column width="50%"}
**ATTï¼ˆå·²æ²»ç™‚è€…æ•ˆæœï¼‰**

- å•ï¼šã€Œå°å·²ç¶“ç”¨é€™æ²»ç™‚çš„äººã€
- åªéœ€å°ç…§çµ„èƒ½ä»£è¡¨æ²»ç™‚çµ„
- é‡ç–Šä¸ä½³æ™‚**æ›´å¯¦éš›å¯ä¼°**
:::
:::

::: {.fragment}
### å¯¦å‹™å»ºè­°

> å¹¾ç™¾ä¾‹çš„è‡¨åºŠè³‡æ–™ï¼Œ**å„ªå…ˆè€ƒæ…® ATT**ï¼Œé™¤éé‡ç–Šéå¸¸å¥½
:::

## å°çµï¼šé¸æ“‡æ–¹æ³•

::: {.incremental}
1. å…ˆç¢ºå®šä½ çš„ **çµæœé¡å‹**ï¼ˆé€£çºŒ/äºŒå…ƒ/å­˜æ´»/è¨ˆæ•¸ï¼‰
2. å†æ±ºå®šä½ è¦ä¼°è¨ˆçš„ **ç›®æ¨™é‡**ï¼ˆATE/ATTï¼‰
3. ç„¶å¾Œé¸æ“‡å°æ‡‰çš„ **R å¥—ä»¶**
:::

::: {.fragment}
> **ä¸‹ä¸€æ­¥**ï¼šæ–¹æ³•é¸å¥½äº†ï¼Œè³‡æ–™è¦æ€éº¼æº–å‚™ï¼Ÿ
:::

# ç¬¬äº”éƒ¨åˆ†ï¼šè³‡æ–™æº–å‚™ {data-stack-name="è³‡æ–™æº–å‚™"}

## æœ¬ç¯€é‡é»

åœ¨è·‘åˆ†æä¹‹å‰ï¼Œè³‡æ–™è¦å…ˆæ•´ç†å¥½ï¼š

::: {.incremental}
- è³‡æ–™æ ¼å¼é•·ä»€éº¼æ¨£ï¼Ÿ
- å“ªäº›è®Šæ•¸è¦æ”¾é€²å»ï¼Ÿ
- æœ‰å“ªäº›å¸¸è¦‹çš„é™·é˜±ï¼Ÿ
:::

## è³‡æ–™æ ¼å¼è¦æ±‚

::: {.columns}
::: {.column width="50%"}
```{r}
#| echo: false
#| message: false
library(gtsummary)
library(dplyr)

set.seed(2024)
n <- 200

age <- round(rnorm(n, 60, 12))
sex <- sample(c("ç”·", "å¥³"), n, replace = TRUE)
ecog <- sample(0:2, n, replace = TRUE, prob = c(0.3, 0.5, 0.2))
comorbidity <- sample(0:2, n, replace = TRUE)
ps <- plogis(
  -1 + 0.03 * age - 0.5 * (sex == "å¥³") - 0.3 * ecog + 0.2 * comorbidity
)
treatment <- rbinom(n, 1, ps)
outcome <- rbinom(n, 1, plogis(-2 + 0.02 * age - 0.8 * treatment + 0.3 * ecog))

data.frame(
  treatment = factor(treatment, labels = c("å°ç…§çµ„", "æ²»ç™‚çµ„")),
  age = age,
  sex = sex,
  ecog = factor(ecog),
  comorbidity = comorbidity,
  outcome = factor(outcome, labels = c("å­˜æ´»", "æ­»äº¡"))
) |>
  tbl_summary(
    by = treatment,
    label = list(
      age ~ "å¹´é½¡",
      sex ~ "æ€§åˆ¥",
      ecog ~ "ECOG",
      comorbidity ~ "å…±ç—…æ•¸",
      outcome ~ "çµæœ"
    )
  ) |>
  add_p() |>
  as_gt() |>
  gt::tab_options(
    table.font.size = gt::px(14),
    data_row.padding = gt::px(2),
    row_group.padding = gt::px(2)
  )
```
:::
::: {.column width="50%"}
**è§€å¯Ÿåˆ°ä»€éº¼ï¼Ÿ**

- æ²»ç™‚çµ„å¹´é½¡è¼ƒé«˜ã€ç”·æ€§è¼ƒå¤š
- å…©çµ„ baseline ç‰¹å¾µä¸å¹³è¡¡

**é™·é˜±**

- ç›´æ¥æ¯”è¼ƒçµæœæœƒæœ‰åèª¤
- éœ€è¦èª¿æ•´æ··æ·†å› å­
- é€™å°±æ˜¯ç‚ºä»€éº¼éœ€è¦å› æœæ¨è«–æ–¹æ³•ï¼
:::
:::

## è³‡æ–™å“è³ªæª¢æŸ¥ï¼ˆæ¯”æ¨¡å‹æ›´é‡è¦ï¼ï¼‰

åœ¨è·‘ä»»ä½•åˆ†æä¹‹å‰ï¼Œ**å…ˆåšé€™ä¸‰ä»¶äº‹**ï¼š

::: {.incremental}
1. **ç¼ºå¤±å€¼è™•ç†**ï¼šä¸è¦é»˜é»˜åˆªé™¤ï¼
2. **é‡ç–Šæª¢æŸ¥**ï¼šå…©çµ„æ˜¯å¦å¯æ¯”ï¼Ÿ
3. **äº‹ä»¶æ•¸è©•ä¼°**ï¼šæ¨£æœ¬å¤ ä¸å¤ ç©©å®šï¼Ÿ
:::

## ç¼ºå¤±å€¼è™•ç†

::: {.callout-warning appearance="minimal"}
## å¸¸è¦‹éŒ¯èª¤
ç›´æ¥åˆªé™¤æœ‰ç¼ºå¤±çš„å€‹æ¡ˆï¼ˆlistwise deletionï¼‰ï¼Œå‡è£æ²’äº‹
:::

| ç¼ºå¤±æ©Ÿåˆ¶ | æ„æ€ | è™•ç†æ–¹å¼ |
|----------|------|----------|
| MCAR | å®Œå…¨éš¨æ©Ÿç¼ºå¤± | åˆªé™¤é‚„å¯ä»¥ï¼ˆä½†æµªè²»è³‡æ–™ï¼‰|
| MAR | å¯è§€å¯Ÿè®Šæ•¸å¯è§£é‡‹ | **å¤šé‡æ’è£œ** (Multiple Imputation) |
| MNAR | ç¼ºå¤±æœ¬èº«æœ‰æ„ç¾© | æ•æ„Ÿåº¦åˆ†æ |

::: {.fragment}
**å»ºè­°**ï¼šç”¨ `mice` å¥—ä»¶åšå¤šé‡æ’è£œï¼Œåœ¨æ¯å¥—æ’è£œè³‡æ–™å…§åˆ†æå†åˆä½µ
:::

## é‡ç–Šæª¢æŸ¥ï¼ˆOverlap / Positivityï¼‰

:::: {.columns}

::: {.column width="50%"}
```{r}
#| echo: false
#| fig-width: 6
#| fig-height: 5

set.seed(789)
n <- 400

# å¥½çš„é‡ç–Šï¼šå…©çµ„ PS å¤§é‡é‡ç–Š
ps_good_treated <- rbeta(n / 2, 3, 3) * 0.6 + 0.2
ps_good_control <- rbeta(n / 2, 3, 3) * 0.6 + 0.2

df_good <- data.frame(
  ps = c(ps_good_treated, ps_good_control),
  group = factor(rep(c("æ²»ç™‚çµ„", "å°ç…§çµ„"), each = n / 2))
)

ggplot(df_good, aes(x = ps, fill = group)) +
  geom_density(alpha = 0.6, color = "white") +
  scale_fill_manual(
    values = c("æ²»ç™‚çµ„" = colors$treatment, "å°ç…§çµ„" = colors$control)
  ) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.25)) +
  labs(
    title = "âœ… å¥½çš„é‡ç–Š",
    x = "Propensity Score",
    y = "Density",
    fill = ""
  ) +
  theme_causal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "top"
  )
```

- å…©çµ„ PS åˆ†å¸ƒå¤§é‡é‡ç–Š
- å¯ä»¥ä¼°è¨ˆ ATE
:::

::: {.column width="50%"}
```{r}
#| echo: false
#| fig-width: 6
#| fig-height: 5

# å·®çš„é‡ç–Šï¼šå…©çµ„ PS å¹¾ä¹ä¸é‡ç–Š
ps_bad_treated <- rbeta(n / 2, 5, 2) * 0.4 + 0.55
ps_bad_control <- rbeta(n / 2, 2, 5) * 0.4 + 0.05

df_bad <- data.frame(
  ps = c(ps_bad_treated, ps_bad_control),
  group = factor(rep(c("æ²»ç™‚çµ„", "å°ç…§çµ„"), each = n / 2))
)

ggplot(df_bad, aes(x = ps, fill = group)) +
  geom_density(alpha = 0.6, color = "white") +
  scale_fill_manual(
    values = c("æ²»ç™‚çµ„" = colors$treatment, "å°ç…§çµ„" = colors$control)
  ) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.25)) +
  labs(
    title = "âŒ å·®çš„é‡ç–Š",
    x = "Propensity Score",
    y = "Density",
    fill = ""
  ) +
  theme_causal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "top"
  )
```

- å…©çµ„ PS å¹¾ä¹ä¸é‡ç–Š
- æ‡‰æ”¹ä¼° ATT æˆ–é™åˆ¶åˆ†æç¯„åœ
:::

::::

::: {.fragment}
### é‡ç–Šä¸å¥½æ€éº¼è¾¦ï¼Ÿ

1. æ”¹ä¼° **ATT**ï¼ˆåªçœ‹æ²»ç™‚çµ„çš„æ•ˆæœï¼‰
2. **Trimming**ï¼šæ’é™¤ PS æ¥µç«¯çš„å€‹æ¡ˆ
3. **Overlap weights**ï¼šçµ¦é‡ç–Šå€åŸŸè¼ƒé«˜æ¬Šé‡
:::

## äº‹ä»¶æ•¸è©•ä¼°

::: {.callout-note appearance="minimal"}
## ç¶“é©—æ³•å‰‡
äºŒå…ƒçµå±€æ™‚ï¼Œäº‹ä»¶æ•¸ < 50 æœƒè®“ä»»ä½•é«˜è‡ªç”±åº¦æ¨¡å‹éƒ½å¾ˆä¸ç©©å®š
:::

| äº‹ä»¶æ•¸ | å»ºè­° |
|--------|------|
| < 30 | æ¥µåº¦ä¿å®ˆï¼šåªèª¿æ•´ 2-3 å€‹æœ€é‡è¦æ··æ·†å› å­ |
| 30-50 | ä¿å®ˆï¼šç”¨æ­£å‰‡åŒ–æ¨¡å‹ã€æ¸›å°‘è®Šæ•¸ |
| 50-100 | æ¨™æº–åˆ†æå¯è¡Œï¼Œä½† Super Learner åº«è¦å° |
| > 100 | å¯ä»¥ç”¨è¼ƒå½ˆæ€§çš„æ¨¡å‹ |

## å¸¸è¦‹è³‡æ–™å•é¡Œç¸½è¡¨

| å•é¡Œ | è§£æ³• |
|------|------|
| éºæ¼å€¼ | Multiple imputationï¼ˆå…ˆè™•ç†ï¼‰|
| æ··æ·†å› å­æ”¾éŒ¯æ™‚é–“é» | åªèƒ½ç”¨ baseline çš„ |
| Time zero ä¸æ˜ç¢º | ä»”ç´°å®šç¾©è¿½è¹¤èµ·é» |
| æ²»ç™‚å®šç¾©æ¨¡ç³Š | æ˜ç¢ºå®šç¾©ä»€éº¼ç®—ã€Œæ¥å—æ²»ç™‚ã€|
| é‡ç–Šä¸ä½³ | æ”¹ ATTã€trimmingã€æˆ–é™åˆ¶åˆ†æç¯„åœ |
| äº‹ä»¶æ•¸å¤ªå°‘ | æ¸›å°‘èª¿æ•´è®Šæ•¸ã€ç”¨æ­£å‰‡åŒ– |

## å­˜æ´»è³‡æ–™æ ¼å¼

```{.r code-line-numbers="1-5|6"}
df_surv <- data.frame(
  id = ...,
  treatment = ...,
  time = ..., # è¿½è¹¤æ™‚é–“
  event = ..., # 1=äº‹ä»¶ï¼Œ0=è¨­é™
  # æ··æ·†å› å­...
)
```

::: {.fragment}
> **ä¸‹ä¸€æ­¥**ï¼šè³‡æ–™æº–å‚™å¥½äº†ï¼Œä¾†çœ‹å¯¦éš›çš„ R ç¨‹å¼ç¢¼ï¼
:::

# ç¬¬å…­éƒ¨åˆ†ï¼šR å¯¦ä½œç¤ºç¯„ {data-stack-name="R å¯¦ä½œ"}

## æœ¬ç¯€é‡é»

çµ‚æ–¼è¦å¯« code äº†ï¼é€™ä¸€ç¯€æœƒç¤ºç¯„ï¼š

::: {.incremental}
- é€£çºŒçµæœï¼šç”¨ `tmle` å¥—ä»¶
- äºŒå…ƒçµæœï¼šç”¨ `tmle` å¥—ä»¶
- å­˜æ´»çµæœï¼šç”¨ `survtmle` å¥—ä»¶
- **å¹³è¡¡è¨ºæ–·**ï¼šç¢ºèªèª¿æ•´æœ‰æ•ˆ
:::

## å®Œæ•´åˆ†ææµç¨‹ï¼š5 æ­¥é©Ÿè¦–è¦ºåŒ–

```{r}
#| echo: false
#| fig-width: 12
#| fig-height: 6

set.seed(42)

# æ¨¡æ“¬æ›´çœŸå¯¦çš„è‡¨åºŠæƒ…å¢ƒï¼šé†«å¸«å‚¾å‘é–‹æ–°è—¥çµ¦å¹´è¼•ã€å¥åº·çš„ç—…äºº
# æ²»ç™‚çµ„ï¼šè¼ƒå¹´è¼•
n_treat <- 150
n_ctrl <- 150

# æ²»ç™‚çµ„å¹´é½¡è¼ƒä½ï¼ˆé†«å¸«åå¥½ï¼‰
age_treat <- round(rnorm(n_treat, 52, 10))
age_ctrl <- round(rnorm(n_ctrl, 62, 10))

# æ²»ç™‚çµ„å…±ç—…è¼ƒå°‘
comorbidity_treat <- rpois(n_treat, 1.0)
comorbidity_ctrl <- rpois(n_ctrl, 2.5)

df_workflow <- data.frame(
  age = c(age_treat, age_ctrl),
  comorbidity = c(comorbidity_treat, comorbidity_ctrl),
  treatment = factor(
    c(rep(1, n_treat), rep(0, n_ctrl)),
    labels = c("å°ç…§çµ„", "æ²»ç™‚çµ„")
  ),
  treatment_num = c(rep(1, n_treat), rep(0, n_ctrl))
)

# è¨ˆç®— PSï¼ˆç”¨ logistic regressionï¼‰
ps_model <- glm(
  treatment_num ~ age + comorbidity,
  data = df_workflow,
  family = binomial
)
df_workflow$ps <- predict(ps_model, type = "response")

# å‰µå»º 5 å€‹å­åœ–
library(patchwork)

# Step 1: åŸå§‹ä¸å¹³è¡¡ - å¹´é½¡åˆ†å¸ƒå·®ç•°æ˜é¡¯
p1 <- ggplot(df_workflow, aes(x = age, fill = treatment)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(
    values = c("å°ç…§çµ„" = colors$control, "æ²»ç™‚çµ„" = colors$treatment)
  ) +
  labs(
    title = "Step 1: åŸå§‹è³‡æ–™ï¼ˆä¸å¹³è¡¡ï¼‰",
    x = "å¹´é½¡",
    y = "Density",
    fill = ""
  ) +
  theme_causal(base_size = 12) +
  theme(legend.position = "bottom")

# Step 2: è¨ˆç®— PS - é¡¯ç¤ºå¹´é½¡å¦‚ä½•é æ¸¬ PS
p2 <- ggplot(df_workflow, aes(x = age, y = ps, color = treatment)) +
  geom_point(alpha = 0.6, size = 1.5) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 1.2) +
  scale_color_manual(
    values = c("å°ç…§çµ„" = colors$control, "æ²»ç™‚çµ„" = colors$treatment)
  ) +
  labs(
    title = "Step 2: è¨ˆç®— PS",
    x = "å¹´é½¡",
    y = "Propensity Score",
    color = ""
  ) +
  theme_causal(base_size = 12) +
  theme(legend.position = "bottom")

# Step 3: æª¢æŸ¥é‡ç–Š - PS åˆ†å¸ƒæœ‰é‡ç–Š
p3 <- ggplot(df_workflow, aes(x = ps, fill = treatment)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(
    values = c("å°ç…§çµ„" = colors$control, "æ²»ç™‚çµ„" = colors$treatment)
  ) +
  labs(
    title = "Step 3: æª¢æŸ¥é‡ç–Š",
    x = "Propensity Score",
    y = "Density",
    fill = ""
  ) +
  theme_causal(base_size = 12) +
  theme(legend.position = "bottom")

# Step 4: SMD æ”¹å–„ - å¾å¯¦éš›è³‡æ–™è¨ˆç®—
mean_age_treat <- mean(df_workflow$age[df_workflow$treatment_num == 1])
mean_age_ctrl <- mean(df_workflow$age[df_workflow$treatment_num == 0])
sd_age <- sd(df_workflow$age)
smd_age_before <- abs(mean_age_treat - mean_age_ctrl) / sd_age

mean_comor_treat <- mean(df_workflow$comorbidity[
  df_workflow$treatment_num == 1
])
mean_comor_ctrl <- mean(df_workflow$comorbidity[df_workflow$treatment_num == 0])
sd_comor <- sd(df_workflow$comorbidity)
smd_comor_before <- abs(mean_comor_treat - mean_comor_ctrl) / sd_comor

smd_data <- data.frame(
  variable = c("å¹´é½¡", "å…±ç—…æ•¸"),
  before = round(c(smd_age_before, smd_comor_before), 2),
  after = c(0.05, 0.04) # åŠ æ¬Šå¾Œå‡è¨­å¹³è¡¡è‰¯å¥½
)
smd_long <- tidyr::pivot_longer(
  smd_data,
  cols = c(before, after),
  names_to = "timing",
  values_to = "smd"
)
smd_long$timing <- factor(
  smd_long$timing,
  levels = c("before", "after"),
  labels = c("åŠ æ¬Šå‰", "åŠ æ¬Šå¾Œ")
)

p4 <- ggplot(
  smd_long,
  aes(x = smd, y = variable, color = timing, shape = timing)
) +
  geom_point(size = 4) +
  geom_vline(xintercept = 0.1, linetype = "dashed", color = "red") +
  scale_color_manual(
    values = c("åŠ æ¬Šå‰" = colors$fragile, "åŠ æ¬Šå¾Œ" = colors$robust)
  ) +
  scale_x_continuous(limits = c(0, 1.2)) +
  labs(
    title = "Step 4: åŠ æ¬Šå¾Œå¹³è¡¡",
    x = "SMD",
    y = "",
    color = "",
    shape = ""
  ) +
  theme_causal(base_size = 12) +
  theme(legend.position = "bottom")

# Step 5: ä¼°è¨ˆæ•ˆæœ - åŸå§‹å·®ç•° vs èª¿æ•´å¾Œ
effect_data <- data.frame(
  method = c("åŸå§‹å·®ç•°\nï¼ˆæœ‰åèª¤ï¼‰", "TMLE ä¼°è¨ˆ\nï¼ˆæ ¡æ­£å¾Œï¼‰"),
  estimate = c(-0.20, -0.08),
  ci_lo = c(-0.28, -0.14),
  ci_hi = c(-0.12, -0.02)
)
effect_data$method <- factor(
  effect_data$method,
  levels = c("åŸå§‹å·®ç•°\nï¼ˆæœ‰åèª¤ï¼‰", "TMLE ä¼°è¨ˆ\nï¼ˆæ ¡æ­£å¾Œï¼‰")
)

p5 <- ggplot(effect_data, aes(x = method, y = estimate, color = method)) +
  geom_hline(yintercept = 0, linetype = "solid", color = "gray50") +
  geom_pointrange(
    aes(ymin = ci_lo, ymax = ci_hi),
    size = 1.2,
    linewidth = 1.5
  ) +
  scale_color_manual(
    values = c(
      "åŸå§‹å·®ç•°\nï¼ˆæœ‰åèª¤ï¼‰" = colors$fragile,
      "TMLE ä¼°è¨ˆ\nï¼ˆæ ¡æ­£å¾Œï¼‰" = colors$robust
    )
  ) +
  scale_y_continuous(limits = c(-0.35, 0.05)) +
  labs(title = "Step 5: ä¼°è¨ˆå› æœæ•ˆæ‡‰", x = "", y = "Risk Difference") +
  theme_causal(base_size = 12) +
  theme(legend.position = "none")

# çµ„åˆ
(p1 | p2 | p3) /
  (p4 | p5) +
  plot_annotation(
    title = "å› æœæ¨è«–åˆ†ææµç¨‹",
    theme = theme(
      plot.title = element_text(
        size = 18,
        face = "bold",
        family = "openhuninn",
        hjust = 0.5
      )
    )
  )
```

::: {.fragment}
**å¾è³‡æ–™åˆ°çµè«–**ï¼šæ¯ä¸€æ­¥éƒ½è¦æª¢æŸ¥ï¼Œä¸æ˜¯è·‘å®Œç¨‹å¼å°±çµæŸï¼
:::

```{r}
#| label: setup-tmle
#| include: false
#| cache: true

# è¼‰å…¥å¥—ä»¶
library(tmle)
library(SuperLearner)
library(dplyr)

# å®šç¾© Super Learner åº«ï¼ˆå°æ¨£æœ¬ç”¨ä¿å®ˆè¨­å®šï¼‰
SL.lib <- c("SL.glm", "SL.glmnet")

# è¼‰å…¥è³‡æ–™
df_cont <- read.csv("data/df_continuous.csv")
df_bin <- read.csv("data/df_binary.csv")
df_surv <- read.csv("data/df_survival.csv")
```

## é€£çºŒçµæœå®Œæ•´ç¯„ä¾‹

```{.r}
library(tmle)
library(SuperLearner)

SL.lib <- c("SL.glm", "SL.glmnet")

fit_cont <- tmle(
  Y = df$outcome,
  A = df$treatment,
  W = df %>% select(age, sex, comorbidity, severity),
  Q.SL.library = SL.lib,
  g.SL.library = SL.lib,
  family = "gaussian"
)

fit_cont$estimates$ATE
```

::: {.fragment .current-only data-code-focus="1-2"}
è¼‰å…¥ `tmle` å’Œ `SuperLearner` å¥—ä»¶ï¼Œé€™æ˜¯é›™é‡ç©©å¥ä¼°è¨ˆçš„æ ¸å¿ƒå·¥å…·ã€‚
:::

::: {.fragment .current-only data-code-focus="4"}
å®šç¾© Super Learner çš„å€™é¸æ¨¡å‹åº«ï¼šGLMï¼ˆç·šæ€§ï¼‰+ GLMNetï¼ˆæ­£å‰‡åŒ–ï¼‰ã€‚å°æ¨£æœ¬å»ºè­°ä¿å®ˆè¨­å®šã€‚
:::

::: {.fragment .current-only data-code-focus="6-13"}
åŸ·è¡Œ TMLEï¼š`Y` æ˜¯çµæœã€`A` æ˜¯æ²»ç™‚ã€`W` æ˜¯æ··æ·†å› å­ã€‚`Q.SL.library` ç”¨æ–¼çµæœæ¨¡å‹ï¼Œ`g.SL.library` ç”¨æ–¼ PS æ¨¡å‹ã€‚
:::

::: {.fragment .current-only data-code-focus="15"}
æå– ATE ä¼°è¨ˆå€¼ï¼ŒåŒ…å«é»ä¼°è¨ˆå’Œ 95% ä¿¡è³´å€é–“ã€‚
:::

## é€£çºŒçµæœï¼šåŸ·è¡Œçµæœ

```{r}
#| label: tmle-continuous
#| echo: false
#| cache: true

fit_cont <- tmle(
  Y = df_cont$outcome,
  A = df_cont$treatment,
  W = df_cont %>% select(age, sex, comorbidity, severity),
  Q.SL.library = SL.lib,
  g.SL.library = SL.lib,
  family = "gaussian"
)
```

```{r}
#| label: tmle-continuous-result
#| echo: true

fit_cont$estimates$ATE
```

::: {.fragment}
**è§£è®€**ï¼šæ²»ç™‚çµ„å¹³å‡è¡€å£“ä¸‹é™æ¯”å°ç…§çµ„å¤šç´„ `r round(fit_cont$estimates$ATE$psi, 1)` mmHgï¼ˆ95% CI: `r round(fit_cont$estimates$ATE$CI[1], 1)` è‡³ `r round(fit_cont$estimates$ATE$CI[2], 1)`ï¼‰
:::

## äºŒå…ƒçµæœ

```{.r}
fit_bin <- tmle(
  Y = df$death,
  A = df$treatment,
  W = df %>% select(age, sex, comorbidity, severity),
  Q.SL.library = SL.lib,
  g.SL.library = SL.lib,
  family = "binomial"
)

fit_bin$estimates$ATE # Risk Difference
fit_bin$estimates$RR  # Risk Ratio
```

::: {.fragment .current-only data-code-focus="1-8"}
äºŒå…ƒçµæœåªéœ€æ”¹å…©è™•ï¼š`Y` æ”¹æˆ 0/1 è®Šæ•¸ï¼ˆå¦‚æ­»äº¡ï¼‰ï¼Œ`family` æ”¹æˆ `"binomial"`ã€‚
:::

::: {.fragment .current-only data-code-focus="10-11"}
äºŒå…ƒçµæœå¯ä»¥æå– **Risk Difference**ï¼ˆé¢¨éšªå·®ï¼‰å’Œ **Risk Ratio**ï¼ˆç›¸å°é¢¨éšªï¼‰å…©ç¨® estimandã€‚
:::

## äºŒå…ƒçµæœï¼šåŸ·è¡Œçµæœ

```{r}
#| label: tmle-binary
#| echo: false
#| cache: true

fit_bin <- tmle(
  Y = df_bin$death,
  A = df_bin$treatment,
  W = df_bin %>% select(age, sex, comorbidity, severity),
  Q.SL.library = SL.lib,
  g.SL.library = SL.lib,
  family = "binomial"
)
```

:::: {.columns}

::: {.column width="50%"}
**Risk Difference**

```{r}
#| label: tmle-binary-rd
#| echo: true

fit_bin$estimates$ATE
```
:::

::: {.column width="50%"}
**Risk Ratio**

```{r}
#| label: tmle-binary-rr
#| echo: true

fit_bin$estimates$RR
```
:::

::::

::: {.fragment}
**è§£è®€**ï¼šæ²»ç™‚é™ä½æ­»äº¡é¢¨éšªç´„ `r round(abs(fit_bin$estimates$ATE$psi) * 100, 1)`%ï¼ˆRD = `r round(fit_bin$estimates$ATE$psi, 3)`ï¼‰
:::

## å­˜æ´»çµæœï¼šTMLE æ–¹æ³•

```{.r}
library(survtmle)

fit_surv <- survtmle(
  ftime = df$time,
  ftype = df$event,
  trt = df$treatment,
  adjustVars = df %>% select(age, sex, comorbidity, severity),
  t0 = 365,
  SL.ftime = SL.lib,
  SL.ctime = SL.lib,
  SL.trt = SL.lib,
  method = "hazard"
)
```

::: {.fragment .current-only data-code-focus="1"}
å­˜æ´»åˆ†æéœ€è¦å°ˆç”¨çš„ `survtmle` å¥—ä»¶ã€‚
:::

::: {.fragment .current-only data-code-focus="4-6"}
`ftime` æ˜¯è¿½è¹¤æ™‚é–“ã€`ftype` æ˜¯äº‹ä»¶æŒ‡æ¨™ï¼ˆ1=äº‹ä»¶ï¼Œ0=è¨­é™ï¼‰ã€`trt` æ˜¯æ²»ç™‚è®Šæ•¸ã€‚
:::

::: {.fragment .current-only data-code-focus="7-8"}
`adjustVars` æ”¾æ··æ·†å› å­ï¼Œ`t0` æŒ‡å®šè¦ä¼°è¨ˆçš„æ™‚é–“é»ï¼ˆå¦‚ 365 å¤©ï¼‰ã€‚
:::

::: {.fragment .current-only data-code-focus="9-12"}
ä¸‰å€‹ Super Learner åº«åˆ†åˆ¥ç”¨æ–¼ï¼šäº‹ä»¶æ™‚é–“æ¨¡å‹ã€è¨­é™æ™‚é–“æ¨¡å‹ã€æ²»ç™‚æ¨¡å‹ã€‚
:::

## å­˜æ´»çµæœï¼šIPW æ›¿ä»£æ–¹æ³•

```{.r}
library(survival)
library(WeightIt)

# è¨ˆç®— PS æ¬Šé‡
w <- weightit(treatment ~ age + sex + comorbidity + severity,
              data = df_surv, method = "ps")

# åŠ æ¬Š Cox è¿´æ­¸
fit_cox <- coxph(Surv(time, event) ~ treatment,
                 data = df_surv, weights = w$weights)
```

::: {.fragment .current-only data-code-focus="1-2"}
ä½¿ç”¨ `survival` åšå­˜æ´»åˆ†æï¼Œ`WeightIt` è¨ˆç®—å‚¾å‘åˆ†æ•¸æ¬Šé‡ã€‚
:::

::: {.fragment .current-only data-code-focus="4-5"}
ç”¨ `weightit()` ä¼°è¨ˆ PS ä¸¦è¨ˆç®— IPW æ¬Šé‡ã€‚
:::

::: {.fragment .current-only data-code-focus="7-8"}
å°‡æ¬Šé‡å¸¶å…¥ `coxph()`ï¼Œä¼°è¨ˆåŠ æ¬Šå¾Œçš„ Hazard Ratioã€‚
:::

## å­˜æ´»çµæœï¼šåŸ·è¡Œçµæœ

```{r}
#| label: survival-ipw
#| echo: false
#| cache: true
#| message: false

library(survival)
library(WeightIt)

# è¨ˆç®— PS æ¬Šé‡
w_surv <- weightit(treatment ~ age + sex + comorbidity + severity,
                   data = df_surv, method = "ps")

# åŠ æ¬Š Cox è¿´æ­¸
fit_cox <- coxph(Surv(time, event) ~ treatment,
                 data = df_surv, weights = w_surv$weights)
```

```{r}
#| label: survival-ipw-result
#| echo: true

summary(fit_cox)$conf.int
```

::: {.fragment}
**è§£è®€**ï¼šåŠ æ¬Šå¾Œ HR = `r round(exp(coef(fit_cox)), 2)`ï¼Œè¡¨ç¤ºæ²»ç™‚çµ„çš„æ­»äº¡é¢¨éšªæ˜¯å°ç…§çµ„çš„ `r round(exp(coef(fit_cox)) * 100, 0)`%
:::

## å¹³è¡¡è¨ºæ–·

```{.r}
library(cobalt)
library(WeightIt)

w <- weightit(
  treatment ~ age + sex + comorbidity + severity,
  data = df,
  method = "ps"
)

# SMD æª¢æŸ¥
bal.tab(w, thresholds = c(m = 0.1))

# è¦–è¦ºåŒ–
love.plot(w, thresholds = c(m = 0.1))
```

::: {.fragment .current-only data-code-focus="1-2"}
`cobalt` ç”¨æ–¼å¹³è¡¡è¨ºæ–·ï¼Œ`WeightIt` ç”¨æ–¼è¨ˆç®—å‚¾å‘åˆ†æ•¸æ¬Šé‡ã€‚
:::

::: {.fragment .current-only data-code-focus="4-8"}
ç”¨ `weightit()` è¨ˆç®—æ¬Šé‡ï¼šå…¬å¼æŒ‡å®šæ··æ·†å› å­ï¼Œ`method = "ps"` ä½¿ç”¨ logistic regression ä¼°è¨ˆ PSã€‚
:::

::: {.fragment .current-only data-code-focus="10-11"}
`bal.tab()` æª¢æŸ¥ SMDï¼Œè¨­å®šé–¾å€¼ 0.1ï¼Œè¶…éè¡¨ç¤ºå¹³è¡¡ä¸ä½³ã€‚
:::

::: {.fragment .current-only data-code-focus="13-14"}
`love.plot()` ç•«å‡º Love Plotï¼Œè¦–è¦ºåŒ–åŠ æ¬Šå‰å¾Œçš„ SMD è®ŠåŒ–ã€‚
:::

## å¹³è¡¡è¨ºæ–·ï¼šåŸ·è¡Œçµæœ

```{r}
#| label: balance-check
#| echo: false
#| cache: true
#| message: false

library(cobalt)

# ä½¿ç”¨ä¹‹å‰è¨ˆç®—çš„æ¬Šé‡
w_bal <- weightit(
  treatment ~ age + sex + comorbidity + severity,
  data = df_bin,
  method = "ps"
)
```

```{r}
#| label: balance-table
#| echo: true

bal.tab(w_bal, thresholds = c(m = 0.1))
```

## å¹³è¡¡è¨ºæ–·ï¼šLove Plot

```{r}
#| label: love-plot-real
#| echo: true
#| fig-width: 8
#| fig-height: 5

love.plot(w_bal, thresholds = c(m = 0.1)) +
  theme_causal()
```

::: {.fragment}
**ç›®æ¨™**ï¼šåŠ æ¬Šå¾Œæ‰€æœ‰è®Šæ•¸çš„ SMD < 0.1ï¼ˆè™›ç·šå·¦å´ï¼‰
:::

## Love Plotï¼šæ›´å¤šè®Šæ•¸ç¯„ä¾‹

```{r}
#| echo: false
#| fig-width: 8
#| fig-height: 5

set.seed(123)

# Simulate SMD data before and after weighting (æ›´å¤šè®Šæ•¸çš„æƒ…å¢ƒ)
vars <- c("å¹´é½¡", "æ€§åˆ¥", "å…±ç—…æ•¸", "åš´é‡åº¦", "BMI", "æŠ½è¸", "ç³–å°¿ç—…", "é«˜è¡€å£“")
smd_before <- c(0.35, 0.22, 0.41, 0.28, 0.15, 0.33, 0.25, 0.19)
smd_after <- c(0.05, 0.03, 0.08, 0.04, 0.02, 0.06, 0.04, 0.03)

df_smd <- data.frame(
  variable = rep(vars, 2),
  smd = c(smd_before, smd_after),
  timing = factor(
    rep(c("åŠ æ¬Šå‰", "åŠ æ¬Šå¾Œ"), each = length(vars)),
    levels = c("åŠ æ¬Šå‰", "åŠ æ¬Šå¾Œ")
  )
)

ggplot(
  df_smd,
  aes(x = smd, y = reorder(variable, smd), color = timing, shape = timing)
) +
  geom_point(size = 4) +
  geom_vline(
    xintercept = 0.1,
    linetype = "dashed",
    color = "red",
    linewidth = 1
  ) +
  scale_color_manual(
    values = c("åŠ æ¬Šå‰" = colors$treatment, "åŠ æ¬Šå¾Œ" = colors$control)
  ) +
  labs(
    x = "Standardized Mean Difference (SMD)",
    y = "",
    color = "",
    shape = ""
  ) +
  annotate(
    "text",
    x = 0.12,
    y = 1,
    label = "é–¾å€¼ 0.1",
    color = "red",
    hjust = 0,
    family = "openhuninn",
    size = 5
  ) +
  theme_causal()
```

::: {.fragment}
**ç›®æ¨™**ï¼šåŠ æ¬Šå¾Œæ‰€æœ‰ SMD < 0.1
:::

## PS é‡ç–Šæª¢æŸ¥

```r
ggplot(df, aes(x = ps, fill = factor(treatment))) +
  geom_density(alpha = 0.5) +
  labs(title = "Propensity Score Overlap")
```

## æ¬Šé‡è¨ºæ–·ï¼ˆå¾ˆé‡è¦ï¼ï¼‰

::: {.callout-warning appearance="minimal"}
## ç‚ºä»€éº¼è¦æª¢æŸ¥æ¬Šé‡ï¼Ÿ
æ¥µç«¯æ¬Šé‡ = å°‘æ•¸äººä¸»å°ä¼°è¨ˆ = çµæœä¸å¯ä¿¡
:::

```r
# æª¢æŸ¥æ¬Šé‡åˆ†å¸ƒ
summary(w$weights)

# æœ€å¤§æ¬Šé‡ï¼ˆä¸è¦å¤ªå¤§ï¼‰
max(w$weights)

# æœ‰æ•ˆæ¨£æœ¬é‡ï¼ˆä¸è¦æ‰å¤ªå¤šï¼‰
sum(w$weights)^2 / sum(w$weights^2)
```

## æœ‰æ•ˆæ¨£æœ¬é‡ (Effective Sample Size)

::: {.columns}
::: {.column width="50%"}
**åŸå§‹æ¨£æœ¬é‡**ï¼š500 äºº

**åŠ æ¬Šå¾Œæœ‰æ•ˆæ¨£æœ¬é‡**ï¼š

$$n_{eff} = \frac{(\sum w_i)^2}{\sum w_i^2}$$
:::
::: {.column width="50%"}
**è§£è®€**

- $n_{eff}$ â‰ˆ åŸå§‹ N â†’ æ¬Šé‡å‡å‹»ï¼Œå¥½
- $n_{eff}$ << åŸå§‹ N â†’ å°‘æ•¸äººä¸»å°ï¼Œè­¦å‘Šï¼
:::
:::

::: {.fragment}
### ç¶“é©—æ³•å‰‡

> æœ‰æ•ˆæ¨£æœ¬é‡æ‰åˆ°åŸå§‹çš„ 50% ä»¥ä¸‹ï¼Œè¦å°å¿ƒè§£è®€çµæœ
:::

## è¨ºæ–·æ¸…å–®ï¼ˆå¯©ç¨¿è€…æœƒçœ‹ï¼ï¼‰

| è¨ºæ–·é …ç›® | ç›®æ¨™ | R å‡½æ•¸ |
|----------|------|--------|
| SMD | å…¨éƒ¨ < 0.1 | `cobalt::bal.tab()` |
| PS é‡ç–Š | å……åˆ†é‡ç–Š | å¯†åº¦åœ– |
| æœ€å¤§æ¬Šé‡ | ä¸è¦å¤ªæ¥µç«¯ | `max(weights)` |
| æœ‰æ•ˆæ¨£æœ¬é‡ | ä¸è¦æ‰å¤ªå¤š | å…¬å¼è¨ˆç®— |

::: {.fragment}
**å ±å‘Šæ™‚å‹™å¿…å‘ˆç¾é€™å››é …ï¼**
:::

## å°çµï¼šR å¯¦ä½œ

å®Œæˆåˆ†æå¾Œï¼Œä½ æ‡‰è©²æœ‰ï¼š

| é …ç›® | ç¢ºèª |
|------|------|
| TMLE ä¼°è¨ˆå€¼ | âœ… ATE å’Œ 95% CI |
| å¹³è¡¡è¨ºæ–· | âœ… SMD < 0.1 |
| PS é‡ç–Š | âœ… å…©çµ„æœ‰è¶³å¤ é‡ç–Š |

::: {.fragment}
> **ä½†æ˜¯**...å°±ç®—ä¸€åˆ‡éƒ½åšå°äº†ï¼Œé‚„æœ‰ä¸€å€‹å•é¡Œï¼š**æœªæ¸¬é‡çš„æ··æ·†å› å­**
:::

# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ•æ„Ÿåº¦åˆ†æ {data-stack-name="æ•æ„Ÿåº¦"}

## æœ¬ç¯€é‡é»

ä½ å¯èƒ½æœƒå•ï¼šã€Œå¦‚æœæœ‰æˆ‘æ²’æ¸¬é‡åˆ°çš„æ··æ·†å› å­æ€éº¼è¾¦ï¼Ÿã€

::: {.fragment}
é€™å°±æ˜¯ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ **æ•æ„Ÿåº¦åˆ†æ**ï¼
:::

::: {.fragment}
- é‡åŒ–ï¼šéœ€è¦å¤šå¼·çš„æœªæ¸¬é‡æ··æ·†æ‰èƒ½æ¨ç¿»çµè«–ï¼Ÿ
- å·¥å…·ï¼šE-valueï¼ˆæœ€ç°¡å–®å¯¦ç”¨ï¼‰
:::

## ç‚ºä»€éº¼éœ€è¦æ•æ„Ÿåº¦åˆ†æï¼Ÿ

::: {.incremental}
- å†å¥½çš„æ–¹æ³•éƒ½ç„¡æ³•è™•ç†ã€Œæœªæ¸¬é‡æ··æ·†ã€
- æ•æ„Ÿåº¦åˆ†æï¼šé‡åŒ–ã€Œéœ€è¦å¤šå¼·çš„æœªæ¸¬é‡æ··æ·†æ‰èƒ½æ¨ç¿»çµè«–ã€
:::

## E-valueï¼ˆæœ€ç°¡å–®å¯¦ç”¨ï¼‰

::: {.callout-note appearance="minimal"}
## ä»€éº¼æ˜¯ E-valueï¼Ÿ
E-value å‘Šè¨´ä½ ï¼šã€Œéœ€è¦å¤šå¼·çš„æœªæ¸¬é‡æ··æ·†å› å­ï¼Œæ‰èƒ½è®“ä½ çš„çµæœè®Šæˆæ²’æœ‰æ•ˆæœã€ã€‚æ•¸å­—è¶Šå¤§ï¼Œçµæœè¶Šç©©å¥ã€‚
:::

```{.r code-line-numbers="1|3-4|6-7|9-11"}
library(EValue)

# äºŒå…ƒçµæœï¼ˆRRï¼‰
evalues.RR(1.5, lo = 1.2, hi = 1.9, true = 1)

# å­˜æ´»çµæœï¼ˆHRï¼‰
evalues.HR(0.7, lo = 0.5, hi = 0.9, true = 1)

# é€£çºŒçµæœï¼ˆå…ˆè½‰æ›ï¼‰
d <- abs(ate) / sd(Y)
rr <- exp(0.91 * d)
evalues.RR(rr, lo = rr_lo, hi = rr_hi, true = 1)
```

## å¦‚ä½•è§£è®€ E-value

E-value = 2.5 è¡¨ç¤ºï¼š

::: {.incremental}
- éœ€è¦ä¸€å€‹ RR â‰¥ 2.5ï¼ˆå° treatmentï¼‰ä¸” RR â‰¥ 2.5ï¼ˆå° outcomeï¼‰çš„æœªæ¸¬é‡æ··æ·†
- æ‰èƒ½å®Œå…¨è§£é‡‹æ‰è§€å¯Ÿåˆ°çš„æ•ˆæœ
- è¶Šå¤§ = è¶Šç©©å¥
- ç¶“é©—æ³•å‰‡ï¼šE-value > 2 é€šå¸¸ç®—ä¸éŒ¯
:::

## E-value è¦–è¦ºåŒ–

```{r}
#| echo: false
#| fig-width: 9
#| fig-height: 5

# Simulate multiple study results with E-values
studies <- data.frame(
  study = c(
    "ç ”ç©¶ A\n(RR=1.8)",
    "ç ”ç©¶ B\n(RR=2.1)",
    "ç ”ç©¶ C\n(RR=1.3)",
    "ç ”ç©¶ D\n(RR=3.0)"
  ),
  rr = c(1.8, 2.1, 1.3, 3.0),
  rr_lo = c(1.3, 1.5, 0.9, 2.0),
  rr_hi = c(2.5, 2.9, 1.9, 4.5),
  evalue = c(3.0, 3.6, 1.9, 5.4),
  evalue_ci = c(1.9, 2.3, 1.0, 3.4)
)

studies$robust <- ifelse(
  studies$evalue_ci >= 2,
  "ç©©å¥ (E-value CI â‰¥ 2)",
  "è¼ƒè„†å¼± (E-value CI < 2)"
)

ggplot(studies, aes(x = evalue, y = reorder(study, evalue), color = robust)) +
  geom_segment(
    aes(x = evalue_ci, xend = evalue, yend = study),
    linewidth = 1.5
  ) +
  geom_point(
    aes(x = evalue_ci),
    size = 4,
    shape = 21,
    fill = "white",
    stroke = 1.5
  ) +
  geom_point(size = 5, shape = 21, aes(fill = robust), stroke = 1.5) +
  geom_vline(
    xintercept = 2,
    linetype = "dashed",
    color = "darkgreen",
    linewidth = 1
  ) +
  scale_color_manual(
    values = c(
      "ç©©å¥ (E-value CI â‰¥ 2)" = colors$robust,
      "è¼ƒè„†å¼± (E-value CI < 2)" = colors$fragile
    )
  ) +
  scale_fill_manual(
    values = c(
      "ç©©å¥ (E-value CI â‰¥ 2)" = colors$robust,
      "è¼ƒè„†å¼± (E-value CI < 2)" = colors$fragile
    )
  ) +
  scale_x_continuous(breaks = 1:6, limits = c(1, 6)) +
  labs(
    x = "E-value",
    y = "",
    color = ""
  ) +
  annotate(
    "text",
    x = 2.1,
    y = 0.6,
    label = "é–¾å€¼ 2.0",
    color = "darkgreen",
    hjust = 0,
    family = "openhuninn",
    size = 5
  ) +
  theme_causal() +
  guides(fill = "none")
```

::: {.fragment}
**å¯¦å¿ƒé»** = E-valueï¼ˆé»ä¼°è¨ˆï¼‰ï¼Œ**ç©ºå¿ƒé»** = E-valueï¼ˆä¿¡è³´å€é–“ä¸‹ç•Œï¼‰
:::

## å°çµï¼šæ•æ„Ÿåº¦åˆ†æ

::: {.incremental}
1. æ•æ„Ÿåº¦åˆ†ææ˜¯å› æœæ¨è«–çš„**å¿…è¦æ­¥é©Ÿ**
2. E-value å‘Šè¨´ä½ çµæœæœ‰å¤šã€Œç©©å¥ã€
3. E-value > 2 é€šå¸¸æ˜¯åˆç†çš„é–€æª»
:::

::: {.fragment}
> **æœ€å¾Œä¸€æ­¥**ï¼šæ€éº¼æŠŠé€™äº›çµæœå¯«æˆè«–æ–‡ï¼Ÿ
:::

# ç¬¬å…«éƒ¨åˆ†ï¼šçµæœå ±å‘Š {data-stack-name="å ±å‘Š"}

## æœ¬ç¯€é‡é»

åˆ†æåšå®Œäº†ï¼Œæ€éº¼å¯«é€²è«–æ–‡ï¼Ÿ

::: {.incremental}
- Methods æ®µè½æ€éº¼å¯«ï¼Ÿ
- éœ€è¦å“ªäº›åœ–è¡¨ï¼Ÿ
- Results æ€éº¼å ±å‘Šï¼Ÿ
:::

## Methods æ€éº¼å¯«

> We estimated the average treatment effect using targeted maximum likelihood estimation (TMLE) with Super Learner for both propensity score and outcome models. The ensemble included logistic regression, random forest, and gradient boosting. Covariate balance was assessed using standardized mean differences (threshold < 0.1). Sensitivity to unmeasured confounding was evaluated using E-values.

## å¿…å‚™åœ–è¡¨

| åœ–è¡¨ | å…§å®¹ |
|------|------|
| Table 1 | Baseline characteristicsï¼ˆåŸå§‹ + åŠ æ¬Šå¾Œï¼‰|
| Figure 1 | PS overlap plot |
| Figure 2 | Love plotï¼ˆSMD å¹³è¡¡åœ–ï¼‰|
| Figure 3 | çµæœåœ–ï¼ˆforest plot / KM curveï¼‰|
| Table 2 | ä¸»çµæœ + 95% CI + E-value |

## çµæœå ±å‘Šç¯„ä¾‹

> The estimated risk difference was âˆ’5.2% (95% CI: âˆ’8.1% to âˆ’2.3%, p = 0.001), indicating the new drug reduced mortality by approximately 5 percentage points. All standardized mean differences were below 0.1 after weighting. The E-value was 2.8, suggesting that substantial unmeasured confounding would be required to explain away the observed effect.

# ç¸½çµ {data-stack-name="ç¸½çµ"}

## å°æ¨£æœ¬çš„å¯¦å‹™åˆ¤æº–ï¼ˆä¸è¦è¸©é›·ï¼ï¼‰

::: {.callout-warning appearance="minimal"}
## å¹¾ç™¾ä¾‹è‡¨åºŠè³‡æ–™çš„å„ªå…ˆé †åº
**ç©©å®šæ€§ > å¯ä¼°æ€§ > æ¨¡å‹è¯éº—ç¨‹åº¦**
:::

::: {.incremental}
1. **ä¸è¦**æŠŠã€Œæ¨¡å‹è¶Šèƒ½åˆ†å‡ºèª°è¢«æ²»ç™‚ã€ç•¶å„ªé» â†’ åˆ†å¤ªé–‹ = é‡ç–Šå·® = æ¨è«–ä¸ç©©
2. **ä¸è¦**æŠŠè™•ç½®å¾Œè®Šé …å¡é€²èª¿æ•´é›†åˆ â†’ é™¤éä½ æ˜ç¢ºåœ¨ä¼°ç›´æ¥æ•ˆæœ
3. **ä¸è¦**åªå ±ä¸€å€‹æ–¹æ³• â†’ è‡³å°‘è¦æœ‰å¹³è¡¡ã€é‡ç–Šã€æ¬Šé‡ã€æ•æ„Ÿåº¦åˆ†æ
4. **è¦**é å…ˆå®£å‘Š estimand å’Œæˆªæ–·è¦å‰‡ â†’ é¿å… p-hacking å«Œç–‘
:::

## ç©©å¥æ€§åˆ†æå»ºè­°

åš 2-3 å€‹æ›¿ä»£åˆ†æï¼Œç¢ºèªçµæœç©©å®šï¼š

| é …ç›® | æ›¿ä»£è¨­å®š |
|------|----------|
| PS æ¨¡å‹ | ç°¡å–®ï¼ˆç·šæ€§ï¼‰vs å½ˆæ€§ï¼ˆGAM/æ­£å‰‡åŒ–ï¼‰|
| æˆªæ–·ç¯„åœ | 0.01/0.99 vs 0.05/0.95 |
| æ–¹æ³• | TMLE vs AIPW vs Matching |
| Estimand | ATE vs ATT |

::: {.fragment}
> å¦‚æœçµè«–åªåœ¨æŸç‰¹å®šè¨­å®šæˆç«‹ï¼Œ**å¿…é ˆåœ¨è¨è«–ä¸­æ‰¿èª**
:::

## å®Œæ•´åˆ†æè¨ˆç•«ç¯„æœ¬

::: {.callout-tip appearance="minimal"}
## å¯ä»¥ç…§æŠ„çš„ checklist
:::

1. å®šç¾© index timeã€è™•ç½® Aã€çµå±€ Yã€è¿½è¹¤çª—
2. ç”¨ DAG æ±ºå®šæ··æ·†å› å­é›†åˆï¼ˆå…¨éƒ¨ baselineï¼‰
3. å¤šé‡æ’è£œè™•ç†ç¼ºå¤±å€¼
4. ä¸» estimandï¼š**ATT**ï¼ˆé‡ç–Šå……åˆ†æ‰æ”¹ ATEï¼‰
5. ä¸»æ–¹æ³•ï¼š**TMLE + cross-fitting (2-fold)**
6. Nuisanceï¼šä¿å®ˆ Super Learner åº« + PS æˆªæ–· [0.01, 0.99]
7. å ±å‘Šï¼šæ•ˆæ‡‰ + 95% CIã€SMDã€æ¬Šé‡ã€é‡ç–Šåœ–ã€E-value

## è§€å¯Ÿæ€§ç ”ç©¶å› æœæ¨è«–æµç¨‹

::: {.incremental}
1. **Target Trial è¨­è¨ˆ**ï¼šå®šç¾©ç ”ç©¶å•é¡Œ
2. **DAG ç•«å‡ºå› æœå‡è¨­**ï¼šç¢ºå®šè¦èª¿æ•´çš„è®Šæ•¸
3. **è³‡æ–™æº–å‚™**ï¼šæ”¶é›† baseline æ··æ·†å› å­
4. **TMLE + Super Learner**ï¼šé›™é‡ç©©å¥ä¼°è¨ˆ
5. **æª¢æŸ¥**ï¼šPS overlap + SMD < 0.1
6. **E-value æ•æ„Ÿåº¦åˆ†æ**ï¼šè©•ä¼°çµæœç©©å¥æ€§
:::

## æ–¹æ³•é¸æ“‡é€ŸæŸ¥

| é¡å‹ | æ–¹æ³• |
|------|------|
| é€£çºŒ | `tmle(..., gaussian)` |
| äºŒå…ƒ | `tmle(..., binomial)` |
| å­˜æ´» | `survtmle()` |
| è¨ˆæ•¸ | IPW + Poisson |

## å¸¸è¦‹å•é¡Œ

| å•é¡Œ | å›ç­” |
|------|------|
| æ¨£æœ¬æ•¸è¦å¤šå°‘ï¼Ÿ | æ²’æœ‰çµ•å°æ¨™æº–ï¼Œä½†æ¯çµ„ > 100 è¼ƒç©©å®š |
| æ··æ·†å› å­è¦æ”¾å¹¾å€‹ï¼Ÿ | æ ¹æ“š DAG æ±ºå®šï¼Œä¸æ˜¯è¶Šå¤šè¶Šå¥½ |
| Reviewer ä¸ç†Ÿ TMLEï¼Ÿ | é™„ PS matching ç•¶ sensitivity analysis |
| PS é‡ç–Šå¾ˆå·®æ€éº¼è¾¦ï¼Ÿ | è€ƒæ…® trimming æˆ– overlap weights |

## å»¶ä¼¸è³‡æº

::: {.incremental}
- HernÃ¡n & Robins "Causal Inference: What If"ï¼ˆå…è²»ç·šä¸Šï¼‰
- `tlverse` æ•™å­¸ç¶²ç«™
- Miguel Hernan çš„ edX èª²ç¨‹
:::

## è¬è¬ï¼ {.center}

Press `?` for keyboard shortcuts.
