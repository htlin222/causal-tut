# 第八部分：敏感度分析 {data-stack-name="敏感度"}

## 本節重點

你可能會問：「如果有我沒測量到的混淆因子怎麼辦？」

::: {.fragment}
這就是為什麼我們需要 **敏感度分析**！
:::

::: {.fragment}
- 量化：需要多強的未測量混淆才能推翻結論？
- 工具：E-value（最簡單實用）
:::

::: {.notes}
這是因果推論最誠實的部分——承認我們可能遺漏了混淆因子。敏感度分析不是要「證明」沒有混淆，而是量化「需要多大的混淆才能推翻結論」。E-value 是目前最流行的方法。
:::


## 流程位置

| 承接 | 本章目標 | 下一步 |
|------|----------|--------|
| 你已完成主要估計與診斷 | **量化未測量混淆的影響** | 把結果寫成論文 |


::: {.notes}
這頁用來定位學習進度，讓學員知道現在在哪一段。

- 請快速點出「承接／本章目標／下一步」三欄的重點。
- 提醒學員此頁是導航，不需要細講內容。
:::

## 為什麼需要敏感度分析？

::: {.incremental}
- 再好的方法都無法處理「未測量混淆」
- 敏感度分析：量化「需要多強的未測量混淆才能推翻結論」
:::

::: {.notes}
這是因果推論的核心限制：我們只能調整「測量到」的混淆因子。再好的方法——TMLE、Super Learner——都無法處理沒測量到的混淆。敏感度分析是誠實面對這個限制的方法。
:::


## E-value（最簡單實用）

::: {.callout-note appearance="minimal"}
## 什麼是 E-value？
E-value 告訴你：「需要多強的未測量混淆因子，才能讓你的結果變成沒有效果」。數字越大，結果越穩健。
:::

```{.r code-line-numbers="1|3-4|6-7|9-11"}
library(EValue)

# 二元結果（RR）
evalues.RR(1.5, lo = 1.2, hi = 1.9, true = 1)

# 存活結果（HR）
evalues.HR(0.7, lo = 0.5, hi = 0.9, true = 1)

# 連續結果（先轉換）
d <- abs(ate) / sd(Y)
rr <- exp(0.91 * d)
evalues.RR(rr, lo = rr_lo, hi = rr_hi, true = 1)
```

::: {.notes}
E-value 的 R 程式碼很簡單。用 EValue 套件的 evalues.RR() 或 evalues.HR()。輸入你的效果估計和信賴區間，它會告訴你 E-value。連續結果要先轉換成 RR，公式在這裡。
:::


## 如何解讀 E-value

E-value = 2.5 表示：

::: {.incremental}
- 需要一個 RR ≥ 2.5（對 treatment）且 RR ≥ 2.5（對 outcome）的未測量混淆
- 才能完全解釋掉觀察到的效果
- 越大 = 越穩健
- 經驗法則：E-value > 2 通常算不錯
:::

::: {.notes}
E-value 的解讀：需要一個「同時影響治療和結果」的未測量混淆因子，其效果至少要這麼強，才能完全解釋掉你觀察到的效果。E-value 越大，結果越穩健。經驗法則是 E-value 大於 2 算不錯。
:::


## E-value 視覺化

```{r}
#| echo: false
#| fig-width: 9
#| fig-height: 5
#| label: evalue-compare-plot

# Simulate multiple study results with E-values
studies <- data.frame(
  study = c(
    "研究 A
(RR=1.8)",
    "研究 B
(RR=2.1)",
    "研究 C
(RR=1.3)",
    "研究 D
(RR=3.0)"
  ),
  rr = c(1.8, 2.1, 1.3, 3.0),
  rr_lo = c(1.3, 1.5, 0.9, 2.0),
  rr_hi = c(2.5, 2.9, 1.9, 4.5),
  evalue = c(3.0, 3.6, 1.9, 5.4),
  evalue_ci = c(1.9, 2.3, 1.0, 3.4)
)

studies$robust <- ifelse(
  studies$evalue_ci >= 2,
  "穩健 (E-value CI ≥ 2)",
  "較脆弱 (E-value CI < 2)"
)

ggplot(studies, aes(x = evalue, y = reorder(study, evalue), color = robust)) +
  geom_segment(
    aes(x = evalue_ci, xend = evalue, yend = study),
    linewidth = 1.5
  ) +
  geom_point(
    aes(x = evalue_ci),
    size = 4,
    shape = 21,
    fill = "white",
    stroke = 1.5
  ) +
  geom_point(size = 5, shape = 21, aes(fill = robust), stroke = 1.5) +
  geom_vline(
    xintercept = 2,
    linetype = "dashed",
    color = "darkgreen",
    linewidth = 1
  ) +
  scale_color_manual(
    values = c(
      "穩健 (E-value CI ≥ 2)" = colors$robust,
      "較脆弱 (E-value CI < 2)" = colors$fragile
    )
  ) +
  scale_fill_manual(
    values = c(
      "穩健 (E-value CI ≥ 2)" = colors$robust,
      "較脆弱 (E-value CI < 2)" = colors$fragile
    )
  ) +
  scale_x_continuous(breaks = 1:6, limits = c(1, 6)) +
  labs(
    x = "E-value",
    y = "",
    color = ""
  ) +
  annotate(
    "text",
    x = 2.1,
    y = 0.6,
    label = "閾值 2.0",
    color = "darkgreen",
    hjust = 0,
    family = "openhuninn",
    size = 5
  ) +
  theme_causal() +
  guides(fill = "none")
```

::: {.fragment}
**實心點** = E-value（點估計），**空心點** = E-value（信賴區間下界）
:::

::: {.notes}
這張圖比較四個研究的 E-value。實心點是點估計的 E-value，空心點是信賴區間下界的 E-value。綠色虛線是閾值 2.0。研究 A 和 B 的信賴區間下界都超過 2，比較穩健。研究 C 的信賴區間下界只有 1.0，比較脆弱。
:::


## 小結：敏感度分析

::: {.incremental}
1. 敏感度分析是因果推論的**必要步驟**
2. E-value 告訴你結果有多「穩健」
3. E-value > 2 通常是合理的門檻
:::

::: {.notes}
這頁收斂本章重點，幫學員把主軸記牢。

- 用一到兩句話重申「關鍵概念」與「下一步」。
- 引導學員把重點連回整體流程。
:::

## 本章輸出

- [ ] 能計算 E-value 並報告 95% CI
- [ ] 能用一句話解讀 E-value 的臨床意義
- [ ] 能指出未測量混淆對結論的影響程度

::: {.fragment}
> **下一步**：怎麼把這些結果寫成論文？
:::

::: {.notes}
敏感度分析的三個重點：必須要做、用 E-value 量化、E-value 大於 2 是合理的門檻。這是因果推論論文的必備內容，審稿者一定會問。接下來是最後一部分——怎麼寫成論文。
:::
